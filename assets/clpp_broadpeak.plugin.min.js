/*! @castlabs/prestoplay 5.1.36, 05-02-2020 Copyright (c) 2020 castLabs GmbH, All Rights reserved */

(function webpackUniversalModuleDefinition(root,factory){if(typeof exports==="object"&&typeof module==="object")module.exports=factory(require("clpp"));else if(typeof define==="function"&&define.amd)define(["clpp"],factory);else if(typeof exports==="object")exports["clpp_broadpeak"]=factory(require("clpp"));else root["clpp_broadpeak"]=factory(root["clpp"])})(this,function(__WEBPACK_EXTERNAL_MODULE_2__){return function(modules){var installedModules={};function __webpack_require__(moduleId){if(installedModules[moduleId])return installedModules[moduleId].exports;var module=installedModules[moduleId]={exports:{},id:moduleId,loaded:false};modules[moduleId].call(module.exports,module,module.exports,__webpack_require__);module.loaded=true;return module.exports}__webpack_require__.m=modules;__webpack_require__.c=installedModules;__webpack_require__.p="/";return __webpack_require__(0)}([function(module,exports,__webpack_require__){__webpack_require__(2);module.exports=__webpack_require__(3);module.exports=__webpack_require__(4)},,function(module,exports){module.exports=__WEBPACK_EXTERNAL_MODULE_2__},function(module,exports){var PlayerEventListener;function init_PlayerEventListener(){return{isPlaying:function(){return metric_manager.getInstance().isPlaying()},isBuffering:function(){return metric_manager.getInstance().isBuffering()},isStarted:function(){return metric_manager.getInstance().isStarted()},onSessionStart:function(){metric_manager.getInstance().onSessionStart()},onSeek:function(b,a){metric_manager.getInstance().onSeek(b,a)},onStallStart:function(){metric_manager.getInstance().onStallStart()},onStallEnd:function(a){metric_manager.getInstance().onStallEnd(a)},onLayerSwitch:function(a){metric_manager.getInstance().onLayerSwitch(a)},onSessionPause:function(){metric_manager.getInstance().onSessionPause()},onSessionResume:function(){metric_manager.getInstance().onSessionResume()}}}var metric_manager;var NANOCDN_STATUS_UNAVAILABLE;var NANOCDN_STATUS_DETECTED_NOT_USED;var NANOCDN_STATUS_USED;function init_metric_manager(){var j=null;var a="http://analytics-players.broadpeak.tv/";var h="fservices/metricsReceiver";var b="LIVE";var g="VOD";var c="api/v1/playermetrics";var i="teardown/";var d="?metrics=";var e="keepalive";var k=1e3;NANOCDN_STATUS_UNAVAILABLE=1;NANOCDN_STATUS_DETECTED_NOT_USED=2;NANOCDN_STATUS_USED=3;var f=function(){this.isSessionRunning=false;this.mCurrentSessionID=null;this.mTeardownActivated=false;this.mStatusCode=0;this.mPlaybackType=null;this.mIsStarted=false;this.mIsPlaying=false;this.mIsBuffering=false;this.mWasSeeking=false;this.mLastSeekTime=0;this.mRedirectedURL=null;this.mContentURL=null;this.mRedirectionTime=0;this.maxRebufferingDuration=0;this.totalRebufferingDuration=0;this.numberOfRebuffering=0;this.maxStallDuration=0;this.totalStallDuration=0;this.numberOfStalls=0;this.mPlayingStartDate=0;this.mPlayDuration=0;this.mComputedStartupTime=0;this.arrayOfWatchingRange=null;this.arrayOfWatchingRangeIndex=0;this.mBeginWatchingPosition=0;this.mTotalDuration=0;this.mStartSessionDate=0;this.mRedirectionStartDate=0;this.mNanoCdnStatus=NANOCDN_STATUS_UNAVAILABLE;this.mStartBufferingTime=0;this.mSendKeepAliveAsyncTask=undefined;this.mNanoCDNHostResolvingAsyncTask=undefined;this.mLastLayerBitrate=null;this.arrayOfSwitchBitrate=null;this.mMinBitrate=0;this.mMaxBitrate=0;this.mAvgBitrate=0;this.mCurrentLayer=-1;this.mAnalyticsAddress=undefined;this.metricsPeriodInSeconds=0;this.mPlayerApi=null;this.mNanoCDNHost=null;this.mBroadpeakDomainNames="*";this.mPlayerName="";this.mPlayerVersion="";this.mDeviceType="";this.mUUID=undefined;this.mCustomParameters={};this.mLastSession=undefined;this.initPlayer=function(m){LoggerManager.getInstance().printMetricsInfoLogs("Init player API...");this.mPlayerApi=m};this.initMetricManager=function(o,n,r,p,q){LoggerManager.getInstance().printMetricsInfoLogs("Init metrics manager...");this.initPlayer(o);this.initPlayerListener(n);this.setAnalyticsPlatformAddress(r);var m=p!==undefined&&p!==null&&p.length!==0;this.mBroadpeakDomainNames=q;this.retrievePlayerName();this.retrieveDeviceType();if(m&&this.mNanoCDNHost!==p){this.resolveNanoCdnHost(p)}else{if(!m){this.setNanoCDNHost("");if(this.mNanoCDNHostResolvingAsyncTask!==undefined){this.mNanoCDNHostResolvingAsyncTask.stopResolving()}}}};this.getSDKVersion=function(){var m=SMARTLIB_VERSION;if(this.mPlayerApi!==null&&typeof this.mPlayerApi.getSDKVersion==="function"){m+="-"+this.mPlayerApi.getSDKVersion()}return m};this.getVersion=function(){return this.getSDKVersion()};this.isStarted=function(){return this.mIsStarted};this.isPlaying=function(){return this.mIsPlaying};this.isBuffering=function(){return this.mIsBuffering};this.isTeardownActive=function(){return this.mTeardownActivated};this.setStatusCode=function(m){this.mStatusCode=m};this.release=function(){this.releaseMetricManager();if(this.mNanoCDNHostResolvingAsyncTask!==undefined){this.mNanoCDNHostResolvingAsyncTask.stopResolving()}};this.setSessionID=function(m){this.mCurrentSessionID=m};this.setContentURL=function(m){this.mContentURL=m};this.setRedirectUrl=function(m){this.mRedirectedURL=m};this.getPlayerPosition=function(){if(this.mPlayerApi!==null&&typeof this.mPlayerApi.getCurrentPosition==="function"){return this.mPlayerApi.getCurrentPosition()}else{return 0}};this.getPlayerTotalDuration=function(){if(this.mPlayerApi!==null&&typeof this.mPlayerApi.getTotalDuration==="function"){return this.mPlayerApi.getTotalDuration()}else{return 0}};this.setPlayerTotalDuration=function(m){this.mTotalDuration=m};this.retrievePlayerVersion=function(){if(this.mPlayerApi!==null&&typeof this.mPlayerApi.getVersion==="function"){this.mPlayerVersion=this.mPlayerApi.getVersion()}else{this.mPlayerVersion=null}};this.setPlayerVersion=function(m){this.mPlayerVersion=m};this.retrieveDeviceType=function(){if(this.mDeviceType===""){if(this.mPlayerApi!==null&&typeof this.mPlayerApi.getDeviceType==="function"){this.mDeviceType=this.mPlayerApi.getDeviceType()}else{this.mDeviceType="NA"}}};this.setDeviceType=function(m){this.mDeviceType=m};this.retrievePlayerName=function(){if(this.mPlayerApi!==null&&typeof this.mPlayerApi.getPlayerName==="function"){this.mPlayerName=this.mPlayerApi.getPlayerName()}else{this.mPlayerName=null}};this.setPlayerName=function(m){this.mPlayerName=m};this.getCurrentBitrate=function(){if(this.mPlayerApi!==null&&typeof this.mPlayerApi.getCurrentBitrate==="function"){return this.mPlayerApi.getCurrentBitrate()}else{return 0}};this.initPeriodicMetrics=function(m){if(m>0){this.metricsPeriodInSeconds=m}};this.setNanoCdnStatusDetected=function(){this.mNanoCdnStatus=NANOCDN_STATUS_DETECTED_NOT_USED};this.setNanoCdnStatusUsed=function(){this.mNanoCdnStatus=NANOCDN_STATUS_USED};this.resolveNanoCdnHost=function(m){LoggerManager.getInstance().printMetricsInfoLogs("Initializing nanoCDN resolving with '"+m+"'");this.setNanoCDNHost("");if(typeof m==="undefined"||m===null||m.length===0){LoggerManager.getInstance().printMetricsInfoLogs("nanoCDN host resolving is not required for '"+m+"'");return}if(this.mNanoCDNHostResolvingAsyncTask!==undefined){this.mNanoCDNHostResolvingAsyncTask.stopResolving()}this.mNanoCDNHostResolvingAsyncTask=new HostResolvingAsyncTask(m);this.mNanoCDNHostResolvingAsyncTask.execute()};this.startStreamingSession=function(n){LoggerManager.getInstance().printMetricsInfoLogs("Starting streaming session...");if(n===undefined||n===null){LoggerManager.getInstance().printMetricsErrorLogs("Exception: You passed a null/undefined contentURL, the session will not work properly.")}this.isSessionRunning=true;this.resetVariables();this.initSessionPlayerObjects();var m=Utils.getInstance().getSessionCreated(n);if(n!==null&&n!==undefined){this.mCurrentSessionID=Utils.getInstance().getTicket(n);this.mTeardownActivated=Utils.getInstance().isTeardownActivated(n,null,this.mBroadpeakDomainNames,this.mNanoCdnStatus);this.mContentURL=n;this.mRedirectedURL=n}if(!this.mTeardownActivated&&!m){this.sendCreationMetricsToPlatform()}LoggerManager.getInstance().printMetricsInfoLogs("Streaming session started")};this.startStreamingSessionRedirect=function(n,m){LoggerManager.getInstance().printMetricsInfoLogs("Starting streaming session...");if(n===undefined||n===null){LoggerManager.getInstance().printMetricsErrorLogs("Exception: You passed a null/undefined contentURL, the session will not work properly.")}if(m===undefined||m===null){LoggerManager.getInstance().printMetricsErrorLogs("Exception: You passed a null/undefined redirectURL, the session will not work properly.")}if(this.mRedirectionStartDate>0){this.mRedirectionTime=Date.now()-this.mRedirectionStartDate}this.resetVariables();this.initSessionPlayerObjects();this.isSessionRunning=true;if(n!==undefined&&n!==null){this.mContentURL=n}if(m!==undefined&&m!==null){if(this.mNanoCDNHost!==null&&this.mNanoCDNHost!==""&&this.mNanoCDNHost!==undefined){if(m.indexOf(this.mNanoCDNHost)>=0){this.setNanoCdnStatusUsed()}else{this.setNanoCdnStatusDetected()}}this.mCurrentSessionID=Utils.getInstance().getTicket(m);this.mTeardownActivated=Utils.getInstance().isTeardownActivated(n,m,this.mBroadpeakDomainNames,this.mNanoCdnStatus);this.mRedirectedURL=m}};this.startStreamingSessionWithRedirect=function(p,m,o){LoggerManager.getInstance().printMetricsInfoLogs("Starting streaming session with redirect...");if(p===undefined||p===null){LoggerManager.getInstance().printMetricsErrorLogs("Exception: You passed a null/undefined contentURL, the session will not work properly.")}var n=this;this.resetVariables();this.initSessionPlayerObjects();this.mRedirectionStartDate=Date.now();redirect_manager.getInstance().getRedirectedUrl(p,this.getAnalyticsPlatformAddress(),this.mNanoCDNHost,this.mBroadpeakDomainNames,function(q){LoggerManager.getInstance().printRedirectorInfoLogs("getURL result: "+q);if(q!==null&&q.length>0){n.isSessionRunning=true}var s=redirect_manager.getInstance().patchBkmResult(q);n.mCurrentSessionID=Utils.getInstance().getTicket(s);n.mTeardownActivated=Utils.getInstance().isTeardownActivated(p,s,n.mBroadpeakDomainNames,n.mNanoCdnStatus);s=redirect_manager.getInstance().removeBroadpeakParameters(s);n.mRedirectedURL=s;if(p!==undefined&&p!==null){n.mContentURL=p}n.mRedirectionTime=Date.now()-n.mRedirectionStartDate;n.mPlayingStartDate=Date.now();var r=Utils.getInstance().getSessionCreated(p);if(!n.isTeardownActive()&&!r){n.sendCreationMetricsToPlatform()}if(typeof m==="function"){m(s)}},function(q){LoggerManager.getInstance().printMetricsErrorLogs("Starting streaming session with redirect failed with error message: "+JSON.stringify(q));if(typeof o==="function"){o(q)}})};this.stopStreamingSession=function(){LoggerManager.getInstance().printMetricsInfoLogs("Stopping streaming session...");this.onStop();this.releaseSessionPlayerObjects();this.sendEndSessionMetricsToPlatform()};this.getQuery=function(){var m=metric_manager.getInstance().getSDKVersion();var p=this.mNanoCDNHost!==null&&this.mNanoCDNHost!==""&&this.mNanoCDNHost!==undefined;var o=p?"nanoCDN host: "+this.mNanoCDNHost:"No nanoCDN host found";LoggerManager.getInstance().printRedirectorInfoLogs("getQuery: "+o+" (v"+m+")");this.mRedirectionStartDate=Date.now();var n="bk-ml=1";if(p){n+="&nanocdnhost="+this.mNanoCDNHost}LoggerManager.getInstance().printRedirectorInfoLogs("getQuery result : "+n);return n};this.sendMetricsToUmbrellaCDN=function(m){};this.initSessionPlayerObjects=function(){if(this.mPlayerApi!==null&&typeof this.mPlayerApi.initSessionPlayerObjects==="function"){return this.mPlayerApi.initSessionPlayerObjects()}else{return 0}};this.releaseSessionPlayerObjects=function(){if(this.mPlayerApi!==null&&typeof this.mPlayerApi.releaseSessionPlayerObjects==="function"){return this.mPlayerApi.releaseSessionPlayerObjects()}else{return 0}};this.resetVariables=function(){LoggerManager.getInstance().resetLogs();this.mStartSessionDate=Date.now();this.mPlayingStartDate=Date.now();this.mCurrentSessionID=null;this.mContentURL=null;this.mRedirectedURL=null;this.mPlaybackType=null;this.mComputedStartupTime=0;this.mLastLayerBitrate=null;this.mBeginWatchingPosition=0;this.mTotalDuration=0;this.mIsPlaying=false;this.mCurrentLayer=-1;this.maxRebufferingDuration=0;this.totalRebufferingDuration=0;this.numberOfRebuffering=0;this.mWasSeeking=false;this.maxStallDuration=0;this.totalStallDuration=0;this.numberOfStalls=0;this.mPlayDuration=0;this.mStatusCode=Utils.getInstance().STATUS_CODE_ENUM.BPSessionEndsNormally.value;this.mIsBuffering=false;this.mIsStarted=false;this.arrayOfWatchingRange=[];this.arrayOfWatchingRangeIndex=0;this.arrayOfSwitchBitrate=[];this.mMinBitrate=0;this.mMaxBitrate=0;this.mAvgBitrate=0;this.mTeardownActivated=false;this.mNanoCdnStatus=NANOCDN_STATUS_UNAVAILABLE};this.sendCreationMetricsToPlatform=function(){var m=new creation_metric(this.mCurrentSessionID,this.mComputedStartupTime,true);this.postCreationMetrics(m)};this.sendEndSessionMetricsToPlatform=function(){LoggerManager.getInstance().printMetricsDebugLogs("Stopping metrics manager");if(this.isSessionRunning===true){this.onSessionEndsWithStatusCode(this.mStatusCode);this.isSessionRunning=false}else{LoggerManager.getInstance().printMetricsErrorLogs("Can't send metrics twice in a session")}};this.postCreationMetrics=function(q){var p=this.getAnalyticsPlatformAddress();if(p!==null){var o=p+h;LoggerManager.getInstance().printMetricsInfoLogs("Posting creation metrics to "+o);var m=new XMLHttpRequest;m.onreadystatechange=function(){if(m.readyState===4){LoggerManager.getInstance().printMetricsInfoLogs("Send creation session metrics ended with with status code: "+m.status);if(m.status<200||m.status>=300){LoggerManager.getInstance().printMetricsDebugLogs("Response text: "+Utils.getInstance().reduceLog(m.responseText,0,100))}if(m.status===503){LoggerManager.getInstance().printMetricsDebugLogs("Request execution failed")}}};m.open("POST",o,true);var n=Utils.getInstance().formatCreationMetricObjectIntoJSON(q);LoggerManager.getInstance().printMetricsVerboseLogs("Executing POST request with body: "+n);m.send(n)}else{LoggerManager.getInstance().printMetricsWarnLogs("Metrics platform URL is null, creation metrics won't be posted anywhere.")}};this.getAnalyticsPlatformAddress=function(){if(typeof this.mAnalyticsAddress==="undefined"||this.mAnalyticsAddress===null||this.mAnalyticsAddress.length===0){return null}return this.mAnalyticsAddress};this.setAnalyticsPlatformAddress=function(m){if(typeof m==="undefined"||m===null||m.length===0){this.mAnalyticsAddress=null;return}if(Utils.getInstance().endsWith(m,"/")){this.mAnalyticsAddress=m}else{this.mAnalyticsAddress=m+"/"}};this.setNanoCDNHost=function(m){if(typeof m==="undefined"||m===null||m.length===0){this.mNanoCDNHost=null;return}this.mNanoCDNHost=m};this.onSessionEndsWithStatusCode=function(n){LoggerManager.getInstance().printMetricsDebugLogs("Session ends with status code: "+n);this.stopKeepAlive();this.mStatusCode=n;if(this.mIsBuffering){this.onBufferingEnd(false)}var m=this.retrieveMetrics();if(m!==null){if(this.mTeardownActivated===true){this.sendTeardownWithMetrics(m)}else{this.postEndSessionMetrics(m)}}this.releaseMetricManager()};this.releaseMetricManager=function(){LoggerManager.getInstance().printMetricsInfoLogs("Releasing metrics manager...")};this.getOSName=function(){if(this.mPlayerApi!==null&&typeof this.mPlayerApi.getOSName==="function"){return this.mPlayerApi.getOSName()}if(typeof device!=="undefined"&&device.platform){return device.platform}if(window!==undefined&&window.navigator!==undefined&&window.navigator.platform!==undefined){return window.navigator.platform}return"NA"};this.getDeviceVersion=function(){if(this.mPlayerApi!==null&&typeof this.mPlayerApi.getDeviceVersion==="function"){return this.mPlayerApi.getDeviceVersion()}if(typeof device!=="undefined"&&device.version){return device.version}var m=window.navigator.appVersion.replace(/ /g,"_").replace(";","_");var n=m.indexOf(")");if(n<=32){return m.substring(0,n+1)}else{return m.substring(0,32)}};this.retrieveAndGetMetrics=function(){this.updatePreviousBitrateRange();this.addWatchingRanges(this.mBeginWatchingPosition,this.getPlayerPosition());if(this.mIsPlaying&&!this.mIsBuffering){this.mPlayDuration+=Date.now()-this.mPlayingStartDate;this.mPlayingStartDate=Date.now()}return this.retrieveMetrics()};this.retrieveMetrics=function(){LoggerManager.getInstance().printMetricsDebugLogs("Retrieving metrics...");var q=this.mRedirectionTime<=0?-1:this.mRedirectionTime;var s=this.mComputedStartupTime+this.mRedirectionTime;s=s<=0?-1:s;this.mPlaybackType=this.mTotalDuration<=0?b:g;var n=this.retrievePercentDurationWatched();if(n>1e3){n=1e3}var u=Math.round(this.mPlayDuration<=0?-1:this.mPlayDuration/1e3);var v=Math.round((Date.now()-this.mStartSessionDate)/1e3);var w=this.arrayOfSwitchBitrate;this.computeBitrates(w);var t=this.retrieveNumberOfSwitch(w);var p=Utils.getInstance().timeSpentPerLayerFromAdaptivePath(this.arrayOfSwitchBitrate);var o=this.getOSName();var r=this.getDeviceVersion();var m=new metric(this.mCurrentSessionID,this.mStatusCode,q,s,this.mPlaybackType,n,u,v,this.numberOfStalls,this.maxStallDuration,this.totalStallDuration,this.numberOfRebuffering,this.maxRebufferingDuration,this.totalRebufferingDuration,this.mContentURL,this.mRedirectedURL,this.mMaxBitrate,this.mMinBitrate,this.mAvgBitrate,t,p,-1,this.mPlayerName,this.mPlayerVersion,o,r,this.mDeviceType,this.mNanoCdnStatus);if(this.mUUID!==undefined&&this.mUUID!==""){m.setUUID(this.mUUID)}m.setCustomParameters(JSON.parse(JSON.stringify(this.mCustomParameters)));LoggerManager.getInstance().printMetricsDebugLogs(m.toString());LoggerManager.getInstance().printMetricsDebugLogs("Metrics are retrieved, ready to be sent");this.mLastSession=m;return m};this.getLastSession=function(){return this.mLastSession};this.retrievePercentDurationWatched=function(){if(this.mPlaybackType===b){return 1e3}var n=JSON.parse(JSON.stringify(this.arrayOfWatchingRange));var p=n.slice(0);if(n.length===1){return Math.floor(p[0].duration*1e3/this.mTotalDuration)}else{if(n.length===0){return 0}}var m=[];var r=null;p=p.sort(function(t,s){if(parseInt(t.start,10)>parseInt(s.start,10)){return 1}if(parseInt(t.start,10)<parseInt(s.start,10)){return-1}return 0});m.push(p[0]);for(var o=1;o<p.length;o++){r=m[m.length-1];if(parseInt(r.end,10)<parseInt(p[o].start,10)){m.push(p[o])}else{if(parseInt(r.end,10)<parseInt(p[o].end,10)){r.end=parseInt(p[o].end,10);r.duration=r.end-r.start;m.pop();m.push(r)}}}var q=0;for(o=0;o<m.length;o++){m[o].duration=parseInt(m[o].end,10)-parseInt(m[o].start,10);q+=parseInt(m[o].duration,10)}this.arrayOfWatchingRange=m;return Math.floor(q*1e3/this.mTotalDuration)};this.retrieveNumberOfSwitch=function(m){if(m.length===0){return 0}else{return m.length-1}};function l(o){var p=0;for(var n=0;n<o.length;n++){var m=o[n];p=p+m.duration}return p}this.addWatchingRanges=function(o,m){if(this.arrayOfWatchingRange!==null&&this.mIsStarted&&o<m){var n=new WatchingRange(o,m);LoggerManager.getInstance().printMetricsVerboseLogs("Add watching range, duration "+n.duration+"ms");this.arrayOfWatchingRange.push(n);this.arrayOfWatchingRangeIndex++}};this.buildCurrentBitrateRange=function(n){var m=Math.floor(n);var o=new Bitrate_range(Date.now(),-1,m,0);LoggerManager.getInstance().printMetricsVerboseLogs("Adding bitrate: ("+o.toString()+")");this.arrayOfSwitchBitrate.push(o);this.mLastLayerBitrate=o;this.mCurrentLayer=n};this.updatePreviousBitrateRange=function(){if(this.mLastLayerBitrate===null){LoggerManager.getInstance().printMetricsVerboseLogs("Last layer is null, cannot update...");return}var m=new Bitrate_range(this.mLastLayerBitrate.getStartDate(),Date.now(),this.mLastLayerBitrate.getBitrate(),0);LoggerManager.getInstance().printMetricsVerboseLogs("Updated bitrate: ("+m.toString()+")");this.arrayOfSwitchBitrate[this.arrayOfSwitchBitrate.length-1]=m};this.retrieveAdaptivePath=function(){if(this.arrayOfSwitchBitrate===null||this.arrayOfSwitchBitrate.length===0){LoggerManager.getInstance().printMetricsVerboseLogs("Player stayed on the same layer");return[]}var n=true;var m=this.arrayOfSwitchBitrate;while(n){m=Utils.getInstance().mergeDuplicateBitrateRange(m);n=Utils.getInstance().hasDuplicateBitrateRange(m)}return m};this.computeBitrates=function(p){this.mAvgBitrate=0;this.mMinBitrate=0;this.mMaxBitrate=0;var n=0;var o=0;if(p.length===0){LoggerManager.getInstance().printMetricsVerboseLogs("No switching bitrate");return}this.mMinBitrate=p[0].getBitrate();for(var m=0;m<p.length;m++){if(p[m].getBitrate()<this.mMinBitrate){this.mMinBitrate=p[m].getBitrate()}if(p[m].getBitrate()>this.mMaxBitrate){this.mMaxBitrate=p[m].getBitrate()}o=o+p[m].getBitrate()*p[m].getDuration();n=Math.floor(n+p[m].getDuration())}o=o/n;if(o<0){LoggerManager.getInstance().printMetricsDebugLogs("Failed retrieving average bitrate");o=-1}else{if(o>this.mMaxBitrate){LoggerManager.getInstance().printMetricsDebugLogs("Average bitrate can't be greater than max bitrate");o=-1}else{if(o<this.mMinBitrate){LoggerManager.getInstance().printMetricsDebugLogs("Average bitrate can't be less than min bitrate");o=-1}}}this.mAvgBitrate=Math.floor(o)};this.postEndSessionMetrics=function(n){var q=this.getAnalyticsPlatformAddress();if(q!==null){var p=q+h;LoggerManager.getInstance().printMetricsInfoLogs("Posting end session metrics to "+p);var m=new XMLHttpRequest;m.onreadystatechange=function(){if(m.readyState===4){LoggerManager.getInstance().printMetricsInfoLogs("Send end session metrics ended with with status code: "+m.status);if(m.status<200||m.status>=300){LoggerManager.getInstance().printMetricsDebugLogs("Response text: "+Utils.getInstance().reduceLog(m.responseText,0,100))}if(m.status===503){LoggerManager.getInstance().printMetricsDebugLogs("Request execution failed")}metric_manager.getInstance().resetCustomParameters()}};m.open("POST",p,true);var o=Utils.getInstance().formatMetricObjectIntoJSON(n);LoggerManager.getInstance().printMetricsVerboseLogs("Executing POST request with body: "+o);m.send(o)}else{LoggerManager.getInstance().printMetricsWarnLogs("Metrics platform URL is null, end metrics won't be posted anywhere.")}};this.sendTeardownWithMetrics=function(n){var p=this.mRedirectedURL;var o=p.indexOf("?");if(o>0){p=p.substring(0,o)}if(!Utils.getInstance().endsWith(p,"/")){p+="/"}p+=i;p+=n.getStatusCode();p+=d+n.getTeardownMetricsString();LoggerManager.getInstance().printMetricsInfoLogs("Sending teardown with metrics to "+p);var m=new XMLHttpRequest;m.onreadystatechange=function(){if(m.readyState===4){LoggerManager.getInstance().printMetricsInfoLogs("Send teardown with metrics end with status code: "+m.status);if(m.status<200||m.status>=300){LoggerManager.getInstance().printMetricsDebugLogs("Response text: "+Utils.getInstance().reduceLog(m.responseText,0,100))}}};m.open("GET",p,true);m.send(null)};this.startKeepAlive=function(){if(this.mTeardownActivated&&(this.mSendKeepAliveAsyncTask===undefined||!this.mSendKeepAliveAsyncTask.isActive())){var m=this.mRedirectedURL;var n=m.indexOf("?");if(n>0){m=m.substring(0,n)}if(!Utils.getInstance().endsWith(m,"/")){m+="/"}m+=e;this.mSendKeepAliveAsyncTask=new SendKeepAliveAsyncTask(this,m);this.mSendKeepAliveAsyncTask.execute()}};this.stopKeepAlive=function(){if(this.mSendKeepAliveAsyncTask!==undefined){this.mSendKeepAliveAsyncTask.stopKeepAlive()}};this.onStartBuffering=function(){LoggerManager.getInstance().printMetricsDebugLogs("Player is buffering");var m=Date.now();if(!this.mIsBuffering&&this.mIsStarted){this.mIsBuffering=true;if(this.mWasSeeking&&m-this.mLastSeekTime>k){this.mWasSeeking=false}this.mStartBufferingTime=Date.now();if(this.mIsPlaying){this.mPlayDuration+=m-this.mPlayingStartDate}}};this.onBufferingEnd=function(n){var m=Date.now();if(this.mIsStarted&&this.mStartBufferingTime>0){this.mIsBuffering=false;var o=Date.now()-this.mStartBufferingTime;if(this.mWasSeeking){this.mWasSeeking=false;this.onRebufferingEndWithTime(n,o)}else{this.onStallingEnd(n,o)}if(n){this.mPlayingStartDate=Date.now()}this.mStartBufferingTime=0}};this.onRebufferingEndWithTime=function(m,n){LoggerManager.getInstance().printMetricsDebugLogs("Player buffered during "+n+"ms");this.numberOfRebuffering++;this.totalRebufferingDuration+=n;if(n>this.maxRebufferingDuration){this.maxRebufferingDuration=n}};this.onStallingEnd=function(m,n){LoggerManager.getInstance().printMetricsDebugLogs("Player stalled during "+n+"ms");this.numberOfStalls++;this.totalStallDuration+=n;if(n>this.maxStallDuration){this.maxStallDuration=n}};this.onJump=function(n,m){LoggerManager.getInstance().printMetricsDebugLogs("Player jumped from "+n+"ms to "+m+"ms");this.addWatchingRanges(this.mBeginWatchingPosition,n);this.mBeginWatchingPosition=m;this.mWasSeeking=true;this.mLastSeekTime=Date.now()};this.onLayerChanged=function(m){LoggerManager.getInstance().printMetricsDebugLogs("Player changed layer to "+m+"kbps");if(this.mIsStarted){if(this.arrayOfSwitchBitrate.length===0){LoggerManager.getInstance().printMetricsDebugLogs("Bitrate updated for the first time, current bandwidth: "+m+"kbps");this.buildCurrentBitrateRange(m)}else{if(m===this.mCurrentLayer){return}LoggerManager.getInstance().printMetricsDebugLogs("Player changed layer, before: "+this.mLastLayerBitrate.getBitrate()+"kbps, now: "+m+"kbps");this.updatePreviousBitrateRange();this.buildCurrentBitrateRange(m)}}this.mCurrentLayer=m};this.onStartDownload=function(m){LoggerManager.getInstance().printMetricsDebugLogs("On start download url: "+m);if(this.mContentURL===null){this.mContentURL=m}else{if(this.mContentURL!==null&&this.mRedirectedURL===null){this.mRedirectedURL=m}else{if(this.mContentURL!==null&&this.mRedirectedURL!==null&&this.mCurrentSessionID===null){this.retrieveTicketFromURL(m)}}}};this.onStartup=function(){if(!this.isSessionRunning){LoggerManager.getInstance().printMetricsErrorLogs("Implementation error: SmartLib.getURL(...) or SmartLib.startStreamingSession(...) should be called prior to onStartup event. This event is called when the first image is displayed.")}LoggerManager.getInstance().printMetricsInfoLogs("Streaming session started");this.retrievePlayerVersion();this.mIsStarted=true;this.mIsPlaying=true;this.mTotalDuration=this.getPlayerTotalDuration();this.mBeginWatchingPosition=this.getPlayerPosition();this.mComputedStartupTime=Date.now()-this.mPlayingStartDate;this.mPlayingStartDate=Date.now();if(this.mCurrentLayer!==-1){this.onLayerChanged(this.mCurrentLayer)}this.startKeepAlive()};this.onPause=function(){if(this.mIsPlaying){LoggerManager.getInstance().printMetricsDebugLogs("Player is paused");this.mIsPlaying=false;if(!this.mIsBuffering){this.mPlayDuration+=Date.now()-this.mPlayingStartDate}this.addWatchingRanges(this.mBeginWatchingPosition,this.getPlayerPosition());this.updatePreviousBitrateRange()}};this.onResume=function(){if(!this.mIsStarted||this.mIsPlaying){return}this.mIsPlaying=true;this.mIsBuffering=false;LoggerManager.getInstance().printMetricsDebugLogs("Player is resumed");this.mPlayingStartDate=Date.now();if(this.mCurrentLayer!==-1){this.onLayerChanged(this.mCurrentLayer)}};this.onStop=function(){LoggerManager.getInstance().printMetricsDebugLogs("Player is stopped");this.stopKeepAlive();if(this.mIsStarted){if(this.mIsPlaying&&!this.mIsBuffering){this.mPlayDuration+=Date.now()-this.mPlayingStartDate}if(this.mIsBuffering){this.onBufferingEnd(this.mIsPlaying)}if(this.mIsPlaying){this.addWatchingRanges(this.mBeginWatchingPosition,this.getPlayerPosition());this.mIsPlaying=false}this.updatePreviousBitrateRange();this.mIsStarted=false}};this.retrieveTicketFromURL=function(m){var o=m;var n=Utils.getInstance().getTicket(o);LoggerManager.getInstance().printMetricsDebugLogs("Ticket: "+n);this.mCurrentSessionID=n};this.retrievePeriodicMetrics=function(){LoggerManager.getInstance().printMetricsDebugLogs("Retrieving periodic metrics...");var o=this.retrieveAdaptivePath();var n=0;if(this.mLastLayerBitrate!==null){n=this.mLastLayerBitrate.getBitrate()}var m=new periodic_metric(this.mCurrentSessionID,this.numberOfStalls,this.totalStallDuration,this.numberOfRebuffering,this.totalRebufferingDuration,n,o===null||o.length===0?0:o.length-1,this.mPlayDuration<=0?-1:this.mPlayDuration);LoggerManager.getInstance().printMetricsDebugLogs(m.toString());LoggerManager.getInstance().printMetricsDebugLogs("Periodic metrics are retrieved, ready to be sent");return m};this.initPeriodicMetricsTask=function(){};this.postPeriodicMetrics=function(){LoggerManager.getInstance().printMetricsDebugLogs("Running post periodic metrics task");var p=this.getAnalyticsPlatformAddress();if(p!==null){var o=p+h;var n=this.retrievePeriodicMetrics();if(n===null){LoggerManager.getInstance().printMetricsErrorLogs("Failed to retrieve metrics timeframe");return}var m=new XMLHttpRequest;m.onreadystatechange=function(){if(m.readyState===4){LoggerManager.getInstance().printMetricsDebugLogs("Send teardown with metrics end with status code : "+m.status+"response text: "+Utils.getInstance().reduceLog(m.responseText,0,100))}};m.open("POST",o,true);m.setRequestHeader("Content-type","application/json");var q=Utils.getInstance().formatPeriodicMetricObjectIntoJSON(n);m.send(q)}else{LoggerManager.getInstance().printMetricsWarnLogs("Metrics platform URL is null, periodic metrics won't be posted anywhere.")}};this.onSessionStart=function(){this.onStartup()};this.onSeek=function(n,m){if(typeof m!=="undefined"){this.onJump(n,m)}else{this.onJump(n,this.getPlayerPosition())}};this.onStallStart=function(){this.onStartBuffering()};this.onStallEnd=function(m){this.onBufferingEnd(m)};this.onLayerSwitch=function(m){if(typeof m!=="undefined"){this.onLayerChanged(m)}else{this.onLayerChanged(this.getCurrentBitrate())}};this.onSessionPause=function(){this.onPause()};this.onSessionResume=function(){this.onResume()};this.initPlayerListener=function(m){LoggerManager.getInstance().printMetricsDebugLogs("Init listeners...")};this.setUUID=function(m){this.mUUID=m};this.setCustomParameter=function(m,n){if(typeof m==="string"&&typeof n==="string"){this.mCustomParameters[m]=n}else{LoggerManager.getInstance().printMetricsWarnLogs("Only string values are accepted for custom parameters")}};this.resetCustomParameters=function(){this.mCustomParameters={}}};return{getInstance:function(){if(j===null){j=new f}return j}}}var SMARTLIB_VERSION="02.04.01";SmartLib=init_SmartLib();OTTClient=init_OTTClient();var SmartLib;function init_SmartLib(){metric_manager=init_metric_manager();LoggerManager=init_LoggerManager();Utils=init_Utils();PlayerEventListener=init_PlayerEventListener();redirect_manager=init_redirect_manager();var b=0;var a=false;return{FORCE_TEARDOWN_DISABLED:-1,FORCE_TEARDOWN_DEFAULT:0,FORCE_TEARDOWN_ENABLED:1,init:function(h,g,j,f,e,d,c){var i=h;a=true;LoggerManager.getInstance().printMetricsInfoLogs("Init SmartLib...");LoggerManager.getInstance().printMetricsInfoLogs("Version: "+SmartLib.getVersion());if(typeof PlayerApiImp!=="undefined"&&typeof PlayerApiImp.setPlayer==="function"){PlayerApiImp.setPlayer(h);i=PlayerApiImp}if((typeof f==="string"||f===null)&&(typeof e==="string"||e===null)&&d===undefined&&c===undefined){LoggerManager.getInstance().printMetricsInfoLogs("Parameters:analyticsAddress="+j+", nanoCDNHost="+f+", broadpeakDomainNames="+e);metric_manager.getInstance().initMetricManager(i,g,j,f,e)}else{if(typeof f==="boolean"&&typeof e==="boolean"&&(typeof d==="string"||d===null)&&(typeof c==="string"||c===null)){if(e===true){SmartLib.setForceTeardown(1)}LoggerManager.getInstance().printMetricsWarnLogs("WARNING: this init method is deprecated, please use SmartLib.init(player, playerListener, analyticsAddress, nanoCDNHost, broadpeakDomainNames) and SmartLib.setForceTeardown(forceTeardown) before init to keep same behavior");LoggerManager.getInstance().printMetricsInfoLogs("Parameters:analyticsAddress="+j+", nanoCDNHost="+d+", broadpeakDomainNames="+c);metric_manager.getInstance().initMetricManager(i,g,j,d,c)}else{LoggerManager.getInstance().printMetricsWarnLogs("WARNING: this init method is deprecated, please use SmartLib.init(player, playerListener, analyticsAddress, nanoCDNHost, broadpeakDomainNames)");
LoggerManager.getInstance().printMetricsInfoLogs('Using SmartLib with default parameters (forceTearDown=SmartLib.FORCE_TEARDOWN_DEFAULT,nanoCdnHost=null,broadpeakDomainNames="*")...');metric_manager.getInstance().initMetricManager(i,g,j,null,"*")}}},getURL:function(f,d,e){if(a){metric_manager.getInstance().startStreamingSessionWithRedirect(f,d,e)}else{var c="Exception: Implementation error, SmartLib.init(...) should be called prior to SmartLib.getURL(...)";LoggerManager.getInstance().printMetricsErrorLogs(c);e(c)}},getQuery:function(){if(a){return metric_manager.getInstance().getQuery()}else{var c="Exception: Implementation error, SmartLib.init(...) should be called prior to SmartLib.getQuery(...)";LoggerManager.getInstance().printMetricsErrorLogs(c);return""}},startStreamingSession:function(d,c){if(typeof c!=="undefined"){metric_manager.getInstance().startStreamingSessionRedirect(d,c)}else{metric_manager.getInstance().startStreamingSession(d)}},stopStreamingSession:function(c){if(c!==undefined&&!isNaN(c)){metric_manager.getInstance().setStatusCode(c)}metric_manager.getInstance().stopStreamingSession()},release:function(){LoggerManager.getInstance().printMetricsInfoLogs("Releasing SmartLib...");metric_manager.getInstance().release();LoggerManager.getInstance().resetLogs()},getVersion:function(){return metric_manager.getInstance().getVersion()},setUUID:function(c){if(c.length>32){metric_manager.getInstance().setUUID(c.substring(0,32))}else{metric_manager.getInstance().setUUID(c)}},setDeviceType:function(c){metric_manager.getInstance().setDeviceType(c)},setCustomParameter:function(c,d){metric_manager.getInstance().setCustomParameter(c,d)},setForceTeardown:function(c){if(typeof c!=="number"){LoggerManager.getInstance().printMetricsErrorLogs("Exception: parameter forceTeardown must be SmartLib.FORCE_TEARDOWN_DISABLED, SmartLib.FORCE_TEARDOWN_DEFAULT or SmartLib.FORCE_TEARDOWN_ENABLED");return}if(c>=1){b=SmartLib.FORCE_TEARDOWN_ENABLED}else{if(c<=-1){b=SmartLib.FORCE_TEARDOWN_DISABLED}else{b=SmartLib.FORCE_TEARDOWN_DEFAULT}}},getMetricManager:function(){return metric_manager.getInstance()},getForceTeardown:function(){return b}}}var OTTClient;function init_OTTClient(){var a=Object.create(SmartLib);a.init=function(e,b,i,d,g,c,h){LoggerManager.getInstance().printMetricsWarnLogs("WARNING: OTTClient is deprecated, please use SmartLib instead.");var f=e;if(typeof PlayerApiImp!=="undefined"&&typeof PlayerApiImp.setPlayer==="function"){PlayerApiImp.setPlayer(e);f=PlayerApiImp}if(typeof c!=="undefined"&&typeof h!=="undefined"){LoggerManager.getInstance().printMetricsInfoLogs("Using detectNanoCDN and nanoCDNHost...");metric_manager.getInstance().initMetricManager(f,b,i,c===true?h:null,"*")}else{if(typeof g!=="undefined"){metric_manager.getInstance().initMetricManager(f,b,i,null,"*")}else{metric_manager.getInstance().initMetricManager(f,b,i,null,"*")}}if(d===true){LoggerManager.getInstance().printMetricsInfoLogs("Multipath allowed but not supported in this version ")}};return a}var NANO_CDN_RR_PORT="8000";var NANO_CDN_CORE_PORT="18081";var redirect_manager;function init_redirect_manager(){var j=null;var a=1e3;var l=2e4;var g="api/v1/redirector";var i="url";var d="Location";var c="RedirectorCDNManager";var b="status";var k="body";var f="session_id";var e="redirect_url";var h=function(){this.getRedirectedUrl=function(s,t,v,E,A,y){LoggerManager.getInstance().printRedirectorInfoLogs("getURL with "+s);if(s===undefined||s===null||s.length===0){LoggerManager.getInstance().printRedirectorWarnLogs("Requested URL is empty");A("");return}var u=m(s);var z=v!==undefined&&v!==null&&v.length!==0;var D=j.isBroadpeakDomainName(E,s);var w=metric_manager.getInstance().getSDKVersion();if(!z){if(E==="*"){LoggerManager.getInstance().printRedirectorInfoLogs("Workflow 5.1 (v"+w+")")}else{if(E===null||E===""){LoggerManager.getInstance().printRedirectorInfoLogs("Workflow 5.3 (v"+w+")")}else{if(D){LoggerManager.getInstance().printRedirectorInfoLogs("Workflow 5.5 => 5.1 (v"+w+")")}else{LoggerManager.getInstance().printRedirectorInfoLogs("Workflow 5.5 => 5.3 (v"+w+")")}}}}else{if(E==="*"){LoggerManager.getInstance().printRedirectorInfoLogs("Workflow 5.2 (v"+w+")")}else{if(E===null||E===""){LoggerManager.getInstance().printRedirectorInfoLogs("Workflow 5.4 (v"+w+")")}else{if(D){LoggerManager.getInstance().printRedirectorInfoLogs("Workflow 5.6 => 5.2 (v"+w+")")}else{LoggerManager.getInstance().printRedirectorInfoLogs("Workflow 5.6 => 5.4 (v"+w+")")}}}}if(z){metric_manager.getInstance().setNanoCdnStatusDetected();var x="";if(u.query!==""){x="&"+u.query}var C="";if(t!==null){C="&ssu="+this.extractHostnamePort(t)}var B="http://"+v+":8000"+u.path+"?response=200&bk-ml=1"+C+"&us="+u.host+x;LoggerManager.getInstance().printRedirectorDebugLogs("Sending request to the nanoCDN ("+v+")...");q(B,a,function(F){LoggerManager.getInstance().printRedirectorDebugLogs("nanoCDN responded with status code "+F.httpStatus);if(F.httpStatus===200||F.httpStatus===503){if(D){var G=n(s,"response","200");G=n(G,"bk-ml","1");G=n(G,"nanocdnhost",v);LoggerManager.getInstance().printRedirectorDebugLogs("Sending request to the BkM/umbrella: "+G);q(G,l,function(H){LoggerManager.getInstance().printRedirectorDebugLogs("BkM/umbrella responded with status code "+H.httpStatus);if(H.httpStatus===200){if(H.redirectedUrl.indexOf(v)>0){metric_manager.getInstance().setNanoCdnStatusUsed()}A(H.redirectedUrl)}else{A("")}})}else{if(F.httpStatus===200){metric_manager.getInstance().setNanoCdnStatusUsed();A(F.redirectedUrl)}else{A(s)}}}else{o(s,D,A)}})}else{o(s,D,A)}};this.removeBroadpeakParameters=function(x){var s=m(x);if(s!==null){var v="";var u=s.query.split("&");for(var t=0;t<u.length;t++){var w=u[t];if(!Utils.getInstance().startsWith(w,"bk-")&&!Utils.getInstance().startsWith(w,"bpk-")){if(t>0){v+="&"}v+=w}else{LoggerManager.getInstance().printRedirectorDebugLogs("Remove query parameter '"+w+"' from url")}}if(v===""){return x.replace("?"+s.query,"")}else{return x.replace(s.query,v)}}else{return x}};this.patchBkmResult=function(u){var s=m(u);if(s!==null){var t=s.query.split("&");if(t.length>=2&&t[0].indexOf("bk-teardown=")===-1){return u.replace("?bk-teardown=","&bk-teardown=")}}return u};this.resolveNanoCDNDomainName=function(v,s,u){var t=new XMLHttpRequest;t.onreadystatechange=function(){if(t.readyState===4){if(t.status===200){s(true)}else{if(t.status!==0){s(false)}}}};t.onerror=function(){u("Can't resolve nanoCDN:'"+v+"' status:"+t.status)};t.ontimeout=function(){u("Timeout while resolving nanoCDN:'"+v+"' status:"+t.status)};t.open("GET","http://"+v+":"+NANO_CDN_CORE_PORT+"/nanocdnstatus.xml",true);t.timeout=500;t.send()};function n(s,v,w){var x=s.indexOf("?"+v+"=");if(x<0){x=s.indexOf("&"+v+"=")}if(x>=0){var t=s.substring(0,s.indexOf(v));var u=s.substring(s.indexOf(v));u=u.indexOf("&")>=0?u.substring(u.indexOf("&")):"";return t+v+"="+w+u}else{return(s.indexOf("?")<0?s+"?":s+"&")+v+"="+w}}function m(t){if(t===null||t===""){return null}var u=t.match("^(https?)\\:\\/\\/(([^:\\/?#]*)(?:\\:([0-9]+))?)([\\/]{0,1}[^?#]*)(\\?[^#]*|)(#.*|)$");var s=u&&{href:t,protocol:u[1],host:u[2],hostname:u[3],port:u[4],path:u[5],query:u[6],hash:u[7]};if(s!==null&&s.query!==null&&s.query.length>0){s.query=s.query.substring(1)}return s}function p(t){var s=t.match(":\\/\\/(www[0-9]?\\.)?(.[^/:]+)");if(s!==null&&s.length>2&&typeof s[2]==="string"&&s[2].length>0){return s[2]}else{return null}}this.extractHostnamePort=function(t){var s;if(t===null||t===""){return""}if(t.indexOf("://")>-1){s=t.split("/")[2]}else{s=t.split("/")[0]}s=s.split("?")[0];return s};function r(u){var s=redirect_manager.getInstance().extractHostnamePort(u);var t=u.indexOf("/",u.indexOf(s)+s.length);if(t>-1){return u.substr(t+1)}else{return null}}function o(v,s,u){if(s){var t=n(v,"response","200");t=n(t,"bk-ml","1");LoggerManager.getInstance().printRedirectorDebugLogs("Sending request to the BkM/umbrella: "+t);q(t,l,function(w){LoggerManager.getInstance().printRedirectorDebugLogs("BkM/umbrella responded with status code "+w.httpStatus);if(w.httpStatus===200){u(w.redirectedUrl)}else{u("")}})}else{u(v)}}this.isBroadpeakDomainName=function(v,u){if(v===null||v===""){return false}else{if(v==="*"){return true}else{var s=m(u);if(s!==null&&s.hostname!==null){var t=v.split(",");return t.indexOf(s.hostname)>=0}else{return false}}}};function q(w,s,v){var t=new XMLHttpRequest;var u="";t.onreadystatechange=function(){if(t.readyState===4){if(t.status!==0){LoggerManager.getInstance().printRedirectorDebugLogs("Status code: "+t.status+" while retriveving URL: "+w);if(t.status===200){var x=t.getResponseHeader(d);if(x!==null&&x.length>0){u=x;LoggerManager.getInstance().printRedirectorDebugLogs("Url extracted from location header: "+u)}else{if(t.responseText!==null&&t.responseText.length>0){u=t.responseText;LoggerManager.getInstance().printRedirectorDebugLogs("Url extracted from response body: "+u)}else{LoggerManager.getInstance().printRedirectorWarnLogs("No redirect url found")}}}v({httpStatus:t.status,redirectedUrl:u})}else{LoggerManager.getInstance().printRedirectorWarnLogs("No response while retrieving request URL:"+w);v({httpStatus:-1,redirectedUrl:""})}}};t.onerror=function(x){};t.ontimeout=function(){LoggerManager.getInstance().printRedirectorWarnLogs("Timeout while retrieving request URL:"+w)};LoggerManager.getInstance().printRedirectorDebugLogs("Starting request asynchronously with url: "+w);t.open("GET",w,true);t.timeout=s;t.send()}};return{getInstance:function(){if(j===null){j=new h}return j}}}var LoggerManager;function init_LoggerManager(){var j=null;var c;var f=[];var d;var b="BpkRedirectorCDNManager";var i="BpkMetricManager";var k={BPError:{value:0,name:"BPError"},BPWarn:{value:1,name:"BPWarn"},BPInfo:{value:2,name:"BPInfo"},BPDebug:{value:3,name:"BPDebug"},BPVerbose:{value:4,name:"BPVerbose"}};var g={BPLogLevelVerbose:{value:1,name:"BPLogLevelVerbose"},BPLogLevelBasic:{value:0,name:"BPLogLevelBasic"},BPLogLevelNone:{value:-1,name:"BPLogLevelNone"}};var e=function(){this.setLogLevel=function(m){c=m};this.getLogLevel=function(){return c};this.getLogs=function(){return f.join("")};this.saveRedirectorLogs=function(m){l(m,b)};this.saveMetricsLogs=function(m){l(m,i)};this.resetLogs=function(){f=[]};this.printRedirectorDebugLogs=function(m){this.saveRedirectorLogs(m);if(c<g.BPLogLevelVerbose.value){return}h(m,k.BPDebug.value)};this.printRedirectorErrorLogs=function(m){this.saveRedirectorLogs(m);if(c<=g.BPLogLevelNone.value){return}h(m,k.BPError.value)};this.printRedirectorInfoLogs=function(m){this.saveRedirectorLogs(m);if(c<=g.BPLogLevelNone.value){return}h(m,k.BPInfo.value)};this.printRedirectorWarnLogs=function(m){this.saveRedirectorLogs(m);if(c<=g.BPLogLevelNone.value){return}h(m,k.BPWarn.value)};this.printRedirectorVerboseLogs=function(m){this.saveRedirectorLogs(m);if(c<g.BPLogLevelVerbose.value){return}h(m,k.BPVerbose.value)};this.printMetricsDebugLogs=function(m){this.saveMetricsLogs(m);if(c<g.BPLogLevelVerbose.value){return}a(m,k.BPDebug.value)};this.printMetricsErrorLogs=function(m){this.saveMetricsLogs(m);if(c<=g.BPLogLevelNone.value){return}a(m,k.BPError.value)};this.printMetricsInfoLogs=function(m){this.saveMetricsLogs(m);if(c<=g.BPLogLevelNone.value){return}a(m,k.BPInfo.value)};this.printMetricsWarnLogs=function(m){this.saveMetricsLogs(m);if(c<=g.BPLogLevelNone.value){return}a(m,k.BPWarn.value)};this.printMetricsVerboseLogs=function(m){this.saveMetricsLogs(m);if(c<g.BPLogLevelVerbose.value){return}a(m,k.BPVerbose.value)}};function l(n,p){var o=(new Date).toLocaleTimeString();var m=""+o+": [ "+p+" ] : "+n+"\n";if(f.length>400){f=[]}f.push(m)}function h(p,m){var o=new Date;var n=o.getDate()<=9?"0"+o.getDate():o.getDate();var r=o.getMonth()+1<=9?"0"+(o.getMonth()+1):o.getMonth()+1;var q=r+"-"+n+" "+o.toLocaleTimeString()+"."+String(o.getMilliseconds()).substr(0,2);switch(m){case k.BPVerbose.value:console.log(q+" V/"+b+": "+p);break;case k.BPDebug.value:console.log(q+" D/"+b+": "+p);break;case k.BPInfo.value:console.log(q+" I/"+b+": "+p);break;case k.BPWarn.value:console.log(q+" W/"+b+": "+p);break;case k.BPError.value:console.log(q+" E/"+b+": "+p);break;default:break}}function a(p,m){var o=new Date;var n=o.getDate()<=9?"0"+o.getDate():o.getDate();var r=o.getMonth()+1<=9?"0"+(o.getMonth()+1):o.getMonth()+1;var q=r+"-"+n+" "+o.toLocaleTimeString()+"."+String(o.getMilliseconds()).substr(0,2);switch(m){case k.BPVerbose.value:console.log(q+" V/"+i+": "+p);break;case k.BPDebug.value:console.log(q+" D/"+i+": "+p);break;case k.BPInfo.value:console.log(q+" I/"+i+": "+p);break;case k.BPWarn.value:console.log(q+" W/"+i+": "+p);break;case k.BPError.value:console.log(q+" E/"+i+": "+p);break;default:break}}return{getInstance:function(){if(j===null){j=new e}return j}}}function creation_metric(c,a,b){this.session_id=c;this.startup_time=a;this.isStarted=b;this.toString=function d(){var e="session metrics: <br/>";if(this.session_id===null){e+="  session id: N/A <br/>"}else{e+="  session id: "+this.session_id+"<br/>"}if(this.startup_time===-1){e+="startup time : N/A<br/>"}else{e+="startup time : "+this.startup_time+"ms<br/>"}return e}}function timeframe_metric(e,a,i,c,g,f,b,h){this.session_id=e;this.number_of_stall=a;this.stall_duration=i;this.number_of_rebuffering=c;this.rebuffering_duration=g;this.instant_bitrate=f;this.number_of_switch=b;this.duration_played=h;this.toString=function d(){var j="time frame metrics : <br/>";j+="<br/>number of stalls : "+this.number_of_stall;if(this.stall_duration===-1){j+="<br/>max stall duration : N/A ms"}else{j+="<br/>max stall duration : "+this.stall_duration+"ms"}j+="<br/>number of rebuffering : "+this.number_of_rebuffering;if(this.rebuffering_duration===-1){j+="<br/>rebuffering duration : N/A ms"}else{j+="<br/>max rebuffering duration : "+this.rebuffering_duration+"ms"}if(this.instant_bitrate===-1){j+="<br/>instant bitrate : N/A"}else{j+="<br/>instant bitrate : "+this.instant_bitrate+" kbps"}if(this.number_of_switch===0){j+="<br/>number of switch : 0"}else{j+="<br/>number of switch : "+this.number_of_switch+""}j+="<br/>duration played : "+this.duration_played+" secs";return j}}function periodic_metric(d,f,b,e,c,i,g,h){this.session_id=d;this.number_of_stalls=f;this.stall_duration=b;this.number_of_rebufferings=e;this.rebuffering_duration=c;this.instant_bitrate=i;this.number_of_switches=g;this.duration_played=h;this.toString=function a(){var j="session metrics : <br/>";if(this.session_id===null){j+="  session id: N/A <br/>"}else{j+="  session id: "+this.session_id+"<br/>"}if(this.number_of_stalls===-1){j+="number of stalls : N/A<br/>"}else{j+="number of stalls : "+this.number_of_stalls+"ms<br/>"}if(this.stall_duration===-1){j+="stall duration : N/A<br/>"}else{j+="stall duration : "+this.stall_duration+"ms<br/>"}if(this.number_of_rebufferings===-1){j+="number of rebufferings : N/A<br/>"}else{j+="number of rebufferings : "+this.number_of_rebufferings+"ms<br/>"}if(this.rebuffering_duration===-1){j+="rebuffering duration : N/A<br/>"}else{j+="rebuffering duration : "+this.rebuffering_duration+"ms<br/>"}if(this.instant_bitrate===-1){j+="instant bitrate : N/A<br/>"}else{j+="instant bitrate : "+this.instant_bitrate+"ms<br/>"}if(this.number_of_switches===-1){j+="number of switches : N/A<br/>"}else{j+="number of switches : "+this.number_of_switches+"ms<br/>"}if(this.duration_played===-1){j+="duration played : N/A<br/>"}else{j+="duration played : "+this.duration_played+"ms<br/>"}return j}}function WatchingRange(c,a){this.start=c;this.end=a;this.duration=a-c;this.toString=function b(){return"watching range : <br/> start : "+this.start+" <br/> end : "+this.end+" <br/> duration: "+this.duration}}function Bitrate_range(b,g,m,i){this.start=b;this.end=g;this.duration=g-b;this.bitrate=m;this.layerIndex=i;this.marked=false;this.toString=function d(){return"Bitrate_range: start: "+b+", end: "+g+", bitrate: "+m+"kbps, index: "+i};this.getBitrate=function k(){return this.bitrate};this.getStartDate=function l(){return this.start};this.getEndDate=function e(){return this.end};this.setEndDate=function c(o){this.end=o};this.getLayerIndex=function a(){return this.layerIndex};this.getDuration=function n(){return this.duration};this.setDuration=function h(o){this.duration=o};this.isMarked=function j(){return this.marked};this.mark=function f(){this.marked=true}}var Utils;function init_Utils(){var L=null;var u="session_id";var C="status_code";var v="startup_time";var m="redirection_time";var s="completion";var y="played_time";var Q="playback_type";var z="cnt_stall";var o="total_stall_time";var w="max_stall_time";var R="cnt_rebuffering";var F="total_rebuffering_time";var f="max_rebuffering_time";var p="redirect_url";var k="content_url";var x="max_bitrate";var r="min_bitrate";var A="average_bitrate";var B="cnt_layer_switch";var n="cnt_frames_dropped";var b="start";var T="player_name";var d="player_version";var h="device_os";var i="device_version";var e="device_type";var U="duration";var j="time_spent_per_layer";var P="multipath";var q="uuid";var H="nano_status";var a="custom_parameters";var M="bk-session_id";var J="bk-session";var K="^(?:[0-9]{1,3}\\.){3}[0-9]{1,3}(:[0-9]+)?$";var D="^([A-Za-z0-9\\_\\-\\.]+)(:[0-9]+)?$";var t="^[0-5a-z]{30,50}$";var I="played_time_prd";var G="instant_bitrate_prd";var E="cnt_layer_switch_prd";var N="total_rebuffering_time_prd";var O="cnt_rebuffering_prd";var l="total_stall_time_prd";var g="cnt_stall_prd";var c=function(){this.STATUS_CODE_ENUM={BPSessionEndsNormally:{value:200,name:"BPSessionEndsNormally"},BPFormatNotSupportedError:{value:3001,name:"BPFormatNotSupportedError"},BPDecodingError:{value:3002,name:"BPDecodingError"},BPNetworkingError:{value:3003,name:"BPNetworkingError"},BPAccessRightError:{value:3004,name:"BPAccessRightError"},BPUnspecifiedError:{value:3005,name:"BPUnspecifiedError"}};this.mergeWatchingRanges=function(af){var ae=[];for(var ad=0;ad<af.length;ad++){var ai=af[ad];if(ad===af.length-1){ae.push(ai);break}var ah=af[ad+1];var ag;if(ai.start<ah.start&&ai.end<ah.end&&ai.end>=ah.start){ag=new WatchingRange(ai.start,ah.end);ae.push(ag);af[ad+1]=ag;af.splice(ad,1)}else{if(ah.start<ai.start&&ah.end<ai.end&&ah.end>=ai.start){ag=new WatchingRange(ah.start,ai.end);ae.push(ag);af[ad+1]=ag;af.splice(ad,1)}else{if(ai.start<=ah.start&&ai.end>ah.end&&ai.duration>ah.duration){ag=new WatchingRange(ai.start,ai.end);ae.push(ag);af[ad+1]=ag;af.splice(ad,1)}else{if(ah.start<=ai.start&&ah.end>ai.end&&ah.duration>ai.duration){ag=new WatchingRange(ah.start,ah.end);af[ad+1]=ag;af.splice(ad,1)}else{if(ai.start<ah.start&&ai.end<ah.start){ae.push(ai)}else{if(ah.start<ai.start&&ah.end<ai.start){ae.push(ai)}}}}}}}return ae};this.hasDuplicateBitrateRange=function(af){var ag=false;mainLoop:for(var ae=0;ae<af.length;ae++){for(var ad=ae+1;ad<af.length;ad++){if(af[ae].getBitrate()===af[ad].getBitrate()){ag=true;break mainLoop}}}return ag};this.sortLayersList=function(ag){var af=[];for(var ae=0;ae<ag.length;ae++){var ai=ag[ae];if(ae===ag.length-1){af.push(ai)}else{var ah=ag[ae+1];if(ai.getBitrate()!==ah.getBitrate()){if(ah.getStartDate()===-1||ah.getEndDate()===-1){af.splice(ae+1,1)}af.push(ai)}else{if(ai.getStart()===-1||ai.getEnd()===-1){af.splice(ae,1)}else{var ad=new Bitrate_range(ai.getStart(),ah.getEnd(),ai.getBitrate(),ai.getDuration()+ah.getDuration());af.push(ad);ae++}}}}return af};this.mergeDuplicateBitrateRange=function(ah){var ag=this.copyRawLayersList(ah);var ae=[];var aj=false;if(ag.length===0){return ae}for(var af=0;af<ag.length;af++){var ak=ag[af];if(!ak.isMarked()){for(var ad=af+1;ad<ag.length;ad++){var ai=ag[ad];if(ak.getBitrate()===ai.getBitrate()){ak.setDuration(ak.getDuration()+ai.getDuration());ak.setEndDate(ai.getEndDate());ai.mark()}}ae.push(ak)}}return ae};this.copyRawLayersList=function(af){var ag=[];for(var ae=0;ae<af.length;ae++){var ad=af[ae];ag.push(new Bitrate_range(ad.getStartDate(),ad.getEndDate(),ad.getBitrate(),ad.getLayerIndex()))}return ag};this.getStatusCodeStringValue=function(ad){var ae=0;if(ad===this.STATUS_CODE_ENUM.BPSessionEndsNormally.value){ae=this.STATUS_CODE_ENUM.BPSessionEndsNormally.name}else{if(ad===this.STATUS_CODE_ENUM.BPFormatNotSupportedError.value){ae=this.STATUS_CODE_ENUM.BPFormatNotSupportedError.name}else{if(ad===this.STATUS_CODE_ENUM.BPDecodingError.value){ae=this.STATUS_CODE_ENUM.BPDecodingError.name}else{if(ad===this.STATUS_CODE_ENUM.BPNetworkingError.value){ae=this.STATUS_CODE_ENUM.BPNetworkingError.name}else{if(ad===this.STATUS_CODE_ENUM.BPAccessRightError.value){ae=this.STATUS_CODE_ENUM.BPAccessRightError.name}else{ae=this.STATUS_CODE_ENUM.BPUnspecifiedError.name}}}}}return ae};this.isSafari=function(){var ad=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0;return ad};this.timeSpentPerLayerFromAdaptivePath=function(ag){var ai=[];for(var af=0;af<ag.length;af++){var ah=false;for(var ae=0;ae<ai.length&&!ah;ae++){if(ag[af].getBitrate()===ai[ae].getBitrate()){ah=true;ai[ae].setEndDate(ag[af].getEndDate());ai[ae].setDuration(ai[ae].getDuration()+ag[af].getDuration())}}if(!ah){var ad=new Bitrate_range(ag[af].getStartDate(),ag[af].getEndDate(),ag[af].getBitrate(),0);ai.push(ad)}}return ai};this.isArraysEquals=function(af,ae){var ad=af.length===ae.length&&af.every(function(ah,ag){return ah===ae[ag]});return ad};this.convertBitrateInKBPS=function W(ae){var ad=ae/1024;ad=parseInt(ad,10);return ad};this.formatMetricObjectIntoJSON=function(ad){var ae=new Array;ae[ae.length]="{";ae[ae.length]=Z(u,ad.session_id);ae[ae.length]=",";ae[ae.length]=ac(m,ad.redirection_time);ae[ae.length]=",";ae[ae.length]=ac(C,ad.status_code);ae[ae.length]=",";ae[ae.length]=ac(v,ad.startup_time);ae[ae.length]=",";ae[ae.length]=ac(s,ad.completion);ae[ae.length]=",";ae[ae.length]=ac(y,ad.duration_played);ae[ae.length]=",";ae[ae.length]=Z(Q,ad.playback_type);ae[ae.length]=",";ae[ae.length]=ac(z,ad.number_of_stalls);ae[ae.length]=",";ae[ae.length]=ac(w,ad.max_stall_duration);ae[ae.length]=",";ae[ae.length]=ac(o,ad.total_stall_duration);ae[ae.length]=",";ae[ae.length]=ac(R,ad.number_of_rebuffering);ae[ae.length]=",";ae[ae.length]=ac(f,ad.max_rebuffering_time);ae[ae.length]=",";ae[ae.length]=ac(F,ad.total_rebuffering_time);ae[ae.length]=",";ae[ae.length]=Z(k,ad.content_url);ae[ae.length]=",";ae[ae.length]=Z(p,ad.redirected_url);ae[ae.length]=",";ae[ae.length]=ac(x,ad.max_bitrate);ae[ae.length]=",";ae[ae.length]=ac(r,ad.min_bitrate);ae[ae.length]=",";ae[ae.length]=ac(A,ad.average_bitrate);ae[ae.length]=",";ae[ae.length]=ac(B,ad.number_of_switch);ae[ae.length]=",";ae[ae.length]=Z(T,ad.player_name);ae[ae.length]=",";ae[ae.length]=Z(d,ad.player_version);ae[ae.length]=",";ae[ae.length]=Z(e,ad.device_type);ae[ae.length]=",";ae[ae.length]=Z(i,ad.device_version);ae[ae.length]=",";ae[ae.length]=Z(h,ad.os_name);ae[ae.length]=",";ae[ae.length]=ac(U,ad.total_duration);ae[ae.length]=",";ae[ae.length]=V(b,false);ae[ae.length]=",";ae[ae.length]=Y();ae[ae.length]=",";ae[ae.length]=ab(ad);ae[ae.length]=",";ae[ae.length]=Z(q,ad.getUUID());ae[ae.length]=",";ae[ae.length]=ac(H,ad.getNanoCdnStatus());if(Object.keys(ad.getCustomParameters()).length>0){ae[ae.length]=",";ae[ae.length]=ac(a,JSON.stringify(ad.getCustomParameters()))}ae[ae.length]="}";return ae.join("")};function Z(ad,ae){return'"'+ad+'":"'+ae+'"'}function ac(ae,ad){return'"'+ae+'":'+ad}function V(ae,af){var ad;if(af){ad='"'+ae+'":"true"'}else{ad='"'+ae+'":"false"'}return ad}function Y(){return'"'+P+'":{}'}function ab(af){var ae="{";for(var ad=0;ad<af.adaptive_path.length;ad++){ae+='"'+af.adaptive_path[ad].getBitrate()+'":'+af.adaptive_path[ad].getDuration()+","}if(af.adaptive_path!==null&&af.adaptive_path.length>0){ae=ae.slice(0,-1)}ae+="}";return'"'+j+'":'+ae}this.generateTicket=function(){var ad="";var ae=Date.now();var ag=X(1e6,9999999);var af=this.btoa(ag+ae);if(af===null){LoggerManager.getInstance().printMetricsWarnLogs("Cannot encode base 64 ticket");return""}ad=af;LoggerManager.getInstance().printMetricsVerboseLogs("Ticket generated: "+ad);return ad};function X(ae,ad){return Math.floor(Math.random()*(ad-ae+1)+ae)}this.formatCreationMetricObjectIntoJSON=function(ad){var ae="{";ae=ae+'"'+u+'":"'+ad.session_id+'",';ae=ae+'"'+v+'":'+ad.startup_time+",";ae=ae+'"'+b+'":'+ad.isStarted+"";ae+="}";return ae};this.formatPeriodicMetricObjectIntoJSON=function(ad){var ae="{";ae=ae+'"'+u+'":"'+ad.session_id+'",';ae=ae+'"'+I+'":'+ad.duration_played+",";ae=ae+'"'+g+'":'+ad.number_of_stalls+",";ae=ae+'"'+l+'":'+ad.stall_duration+",";ae=ae+'"'+O+'":'+ad.number_of_rebufferings+",";ae=ae+'"'+N+'":'+ad.rebuffering_duration+",";ae=ae+'"'+G+'":'+ad.instant_bitrate+",";ae=ae+'"'+E+'":'+ad.number_of_switches+",";ae=ae+'"'+b+'":"Periodic"';ae+="}";return ae};this.startsWith=function(ae,ad){return ae.indexOf(ad)===0};this.endsWith=function(ae,ad){if(ae===null||ae===undefined){return false}return ae.indexOf(ad,ae.length-ad.length)!==-1};this.reduceLog=function(af,ae,ag){try{return af.substring(ae,ag).replace(new RegExp("\n","g")," ")}catch(ad){return af}};this.getTeardown=function(ad){var ae=this.getParameterByName("bk-teardown",ad);return this.startsWith(ae,"T")||this.startsWith(ae,"t")||this.startsWith(ae,"1")};this.isTeardownActivated=function(ag,ae,af,ad){if(SmartLib.getForceTeardown()===SmartLib.FORCE_TEARDOWN_ENABLED){LoggerManager.getInstance().printMetricsInfoLogs("Session will start with keepalives/teardown (forceTeardown)");return true}if(SmartLib.getForceTeardown()===SmartLib.FORCE_TEARDOWN_DISABLED){LoggerManager.getInstance().printMetricsInfoLogs("Session will start without keepalives/teardown (forceTeardown)");return false}if(ae!==null&&this.getParameterByName("bk-teardown",ae)==="0"){LoggerManager.getInstance().printMetricsInfoLogs("Session will start without keepalives/teardown (bk-teardown=0)");return false}if(ae!==null&&this.getTeardown(ae)){LoggerManager.getInstance().printMetricsInfoLogs("Session will start with keepalives/teardown (bk-teardown=1)");return true}if(ag!==null&&redirect_manager.getInstance().isBroadpeakDomainName(af,ag)){LoggerManager.getInstance().printMetricsInfoLogs("Session will start with keepalives/teardown (in broadpeak domains list)");return true}if(ad===NANOCDN_STATUS_USED){LoggerManager.getInstance().printMetricsInfoLogs("Session will start with keepalives/teardown (nanoCDN used)");return true}LoggerManager.getInstance().printMetricsInfoLogs("Session will start without keepalives/teardown");return false};this.getSessionCreated=function(ad){var ae=this.getParameterByName(M,ad);if(ae!==""){return true}ae=this.getParameterByName(J,ad);return this.startsWith(ae,"T")||this.startsWith(ae,"t")||this.startsWith(ae,"1")};this.getTicket=function(ag){var ah="";var af;ah=this.getParameterByName(M,ag);if(ah===""){af=ag.split("/");if(af.length>=4){if(af[3].match("\\[(.*)\\]")){ah=af[3].substring(1,af[3].length-1)}}}if(ah===""){var ae=ag.split("//");var ad=ae[ae.length-1];af=ad.split("/");if(af.length>=2){if((af[0].match(K)||af[0].match(D))&&af[1].match(t)){ah=af[1];LoggerManager.getInstance().printMetricsVerboseLogs("Ticket detected: "+ah)}}}if(ah===""){ah=this.generateTicket()}if(ah===""){LoggerManager.getInstance().printMetricsWarnLogs("Failed getting ticket");LoggerManager.getInstance().printMetricsWarnLogs("Metrics library won't be able to post metrics")}return ah};this.getParameterByName=function(ae,ad){if(!ad){return""}ae=ae.replace(/[\[\]]/g,"\\$&");var ag=new RegExp("[?&]"+ae+"(=([^&#]*)|&|#|$)");var af=ag.exec(ad);if(!af){return""}if(!af[2]){return""}return decodeURIComponent(af[2].replace(/\+/g," "))};function aa(ad){if(ad<26){return String.fromCharCode(ad+"A".charCodeAt(0))}if(ad<52){return String.fromCharCode(ad-26+"a".charCodeAt(0))}if(ad<62){return String.fromCharCode(ad-52+"0".charCodeAt(0))}if(ad===62){return"+"}if(ad===63){return"/"}}this.btoa=function(ah){var ag;ah=String(ah);for(ag=0;ag<ah.length;ag++){if(ah.charCodeAt(ag)>255){return null}}var ae="";for(ag=0;ag<ah.length;ag+=3){var af=[undefined,undefined,undefined,undefined];af[0]=ah.charCodeAt(ag)>>2;af[1]=(ah.charCodeAt(ag)&3)<<4;if(ah.length>ag+1){af[1]|=ah.charCodeAt(ag+1)>>4;af[2]=(ah.charCodeAt(ag+1)&15)<<2}if(ah.length>ag+2){af[2]|=ah.charCodeAt(ag+2)>>6;af[3]=ah.charCodeAt(ag+2)&63}for(var ad=0;ad<af.length;ad++){if(typeof af[ad]==="undefined"){ae+="="}else{ae+=aa(af[ad])}}}return ae}};function S(W){var V=0;if(W===STATUS_CODE_ENUM.BPSessionEndsNormally.name){V=STATUS_CODE_ENUM.BPSessionEndsNormally.value}else{if(W==="BPFormatNotSupportedError"){V=STATUS_CODE_ENUM.BPFormatNotSupportedError.value}else{if(W==="BPDecodingError"){V=STATUS_CODE_ENUM.BPDecodingError.value}else{if(W==="BPNetworkingError"){V=STATUS_CODE_ENUM.BPNetworkingError.value}else{if(W==="BPAccessRightError"){V=STATUS_CODE_ENUM.BPAccessRightError}else{if(W==="BPUnspecifiedError"){V=STATUS_CODE_ENUM.BPUnspecifiedError}}}}}}return V}return{getInstance:function(){if(L===null){L=new c}return L}}}function metric(c,i,r,D,h,p,n,o,d,u,s,m,A,e,z,g,B,k,l,w,f,C,j,a,q,y,b,v){this.session_id=c;this.redirection_time=r;this.status_code=i;this.startup_time=D;this.completion=p;this.duration_played=n;this.playback_type=h;this.number_of_stalls=d;this.max_stall_duration=u;this.total_stall_duration=s;this.number_of_rebuffering=m;this.max_rebuffering_time=A;this.total_rebuffering_time=e;this.content_url=z;this.redirected_url=g;this.max_bitrate=B;this.min_bitrate=k;this.average_bitrate=l;this.number_of_switch=w;this.adaptive_path=f;this.player_name=j;this.player_version=a;this.device_version=y;this.device_type=b;this.os_name=q;this.total_duration=o;this.frames_dropped_number=C;this.nanocdn_status=v;this.mUUID="";this.mCustomParameters={};this.toString=function x(){var F=new Array;F[F.length]="Session metrics:";F[F.length]="\nsession id: "+this.session_id;F[F.length]="\nplayer name: "+this.player_name;F[F.length]="\nplayer version: "+this.player_version;F[F.length]="\ndevice type: "+this.device_type;F[F.length]="\ndevice version: "+this.device_version;F[F.length]="\nos name: "+this.os_name;F[F.length]="\nuuid: "+this.mUUID;if(this.redirection_time===-1){F[F.length]="\nredirection time: N/A"}else{F[F.length]="\nredirection time: "+this.redirection_time+"ms"}F[F.length]="\nstatus code: "+Utils.getInstance().getStatusCodeStringValue(this.status_code);if(this.startup_time===-1){F[F.length]="\nstartup time: N/A"}else{F[F.length]="\nstartup time: "+this.startup_time+"ms"}F[F.length]="\ncompletion: "+this.completion/10+"%";F[F.length]="\nduration played: "+this.duration_played+" secs";F[F.length]="\ntotal duration: "+this.total_duration+" secs";F[F.length]="\nplayback type: "+this.playback_type;F[F.length]="\nnumber of stalls: "+this.number_of_stalls;if(this.max_stall_duration===-1){F[F.length]="\nmax stall duration: N/A"}else{F[F.length]="\nmax stall duration: "+this.max_stall_duration+"ms"}if(this.total_stall_duration===-1){F[F.length]="\ntotal stall duration: N/A"}else{F[F.length]="\ntotal stall duration: "+this.total_stall_duration+"ms"}F[F.length]="\nnumber of rebuffering: "+this.number_of_rebuffering;F[F.length]="\nmax rebuffering time: "+this.max_rebuffering_time+"ms";F[F.length]="\ntotal rebuffering time: "+this.total_rebuffering_time+"ms";F[F.length]="\ncontent url: "+this.content_url;F[F.length]="\nredirected url: "+this.redirected_url;if(this.max_bitrate===-1){F[F.length]="\nmax bitrate: N/A"}else{F[F.length]="\nmax bitrate: "+this.max_bitrate+" kbps"}if(this.min_bitrate===-1){F[F.length]="\nmin bitrate: N/A"}else{F[F.length]="\nmin bitrate: "+this.min_bitrate+" kbps"}if(this.average_bitrate===-1){F[F.length]="\naverage bitrate: N/A"}else{F[F.length]="\naverage bitrate: "+this.average_bitrate+" kbps"}if(this.number_of_switch===0){F[F.length]="\nnumber of switch: N/A"}else{F[F.length]="\nnumber of switch: "+this.number_of_switch+""}if(this.number_of_switch===null){F[F.length]="\ntime per layer: N/A"}else{F[F.length]="\ntime per layer: ";if(this.adaptive_path.length===0){F[F.length]=" N/A"}else{for(var E=0;E<this.adaptive_path.length;E++){F[F.length]="\n layer "+E+": "+this.adaptive_path[E].getBitrate()+"kbps,"+this.adaptive_path[E].getDuration()+"ms";
}}}F[F.length]="\nnanocdn status: "+v;if(this.mCustomParameters!==undefined){F[F.length]="\ncustom parameters: "+JSON.stringify(this.mCustomParameters)}return F.join("")};this.getStatusCode=function(){return this.status_code};this.getUUID=function(){return this.mUUID};this.setUUID=function(E){this.mUUID=E};this.getNanoCdnStatus=function(){return this.nanocdn_status};this.getCustomParameters=function(){return this.mCustomParameters};this.setCustomParameters=function(E){this.mCustomParameters=E};this.getTeardownMetricsString=function(){var E=this.redirection_time+"+"+encodeURIComponent(this.player_name)+"+"+encodeURIComponent(this.player_version)+"+"+encodeURIComponent(this.os_name)+"+"+encodeURIComponent(this.device_version)+"+"+encodeURIComponent(this.device_type)+"+"+this.startup_time+"+"+this.completion+"+"+this.duration_played+"+"+this.playback_type+"+"+this.number_of_stalls+"+"+this.max_stall_duration+"+"+this.total_stall_duration+"+"+this.number_of_rebuffering+"+"+this.max_rebuffering_time+"+"+this.total_rebuffering_time+"+"+this.max_bitrate+"+"+this.min_bitrate+"+"+this.average_bitrate+"+"+this.number_of_switch+"+"+this.total_duration+"+"+t(this.adaptive_path)+"+"+encodeURIComponent(this.mUUID)+"+"+this.nanocdn_status;return E};function t(H){var G="";for(var F=0;F<H.length;F++){var E=H[F];if(G!==""){G+=","}G+=E.getBitrate()+":"+E.getDuration()}return G}}function SendKeepAliveAsyncTask(b,e){var d="?metrics=";var c=5e3;var a=this;this.mMetricManager=b;this.mMetricsPlatformURL=e;this.mActive=true;this.mInterval=undefined;this.execute=function(){this.mInterval=setInterval(function(){if(a.mActive){var h=a.mMetricManager.retrieveAndGetMetrics();var g=a.mMetricsPlatformURL+d+h.getTeardownMetricsString();LoggerManager.getInstance().printMetricsInfoLogs("Sending keepalive with metrics to "+g);var f=new XMLHttpRequest;f.onreadystatechange=function(){if(f.readyState===4){LoggerManager.getInstance().printMetricsInfoLogs("Send keepalive with metrics end with status code: "+f.status);if(f.status<200||f.status>=300){LoggerManager.getInstance().printMetricsDebugLogs("Response text: "+Utils.getInstance().reduceLog(f.responseText,0,100));LoggerManager.getInstance().printMetricsDebugLogs("Stopping keepalive...");a.stopKeepAlive()}}};f.open("GET",g,true);f.send(null)}},c)};this.stopKeepAlive=function(){this.mActive=false;clearInterval(this.mInterval)};this.isActive=function(){return this.mActive}}function HostResolvingAsyncTask(c){var b=1e4;var a=this;this.mNanoCDNHost=c;this.mRetry=0;this.mActive=true;this.mTimeout=undefined;this.execute=function(){LoggerManager.getInstance().printMetricsDebugLogs("Starting resolving nanoCDN with host: '"+a.mNanoCDNHost+"'");redirect_manager.getInstance().resolveNanoCDNDomainName(a.mNanoCDNHost,function(d){if(a.mActive){LoggerManager.getInstance().printMetricsInfoLogs("Found nanoCDN with host: '"+a.mNanoCDNHost+"'");metric_manager.getInstance().setNanoCDNHost(a.mNanoCDNHost);a.mActive=false}},function(d){if(a.mActive){a.mRetry++;LoggerManager.getInstance().printMetricsDebugLogs(d+" retry:"+a.mRetry);if(a.mRetry<4){clearTimeout(a.mTimeout);a.mTimeout=setTimeout(function(){if(a.mActive){a.execute()}},b*a.mRetry)}else{LoggerManager.getInstance().printMetricsInfoLogs("Can't found nanoCDN with host: '"+a.mNanoCDNHost+"'");a.mActive=false}}})};this.stopResolving=function(){if(!this.mActive){LoggerManager.getInstance().printMetricsDebugLogs("Host resolving stopped for '"+a.mNanoCDNHost+"'")}this.mActive=false;clearTimeout(this.mTimeout)};this.isActive=function(){return this.mActive}}var broadpeak={OTTClient:OTTClient,SmartLib:SmartLib,LoggerManager:LoggerManager,PlayerEventListener:PlayerEventListener};if(typeof module!=="undefined"&&module.exports){module.exports=broadpeak}else{window.broadpeak=broadpeak}},function(module,exports){!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports["clpp_broadpeak"]=t():e["clpp_broadpeak"]=t()}(this,function(){return webpackJsonpclpp__name_([11],{0:function(e,t,i){function n(){}function r(e){if(!_[e])throw new Error('Version "'+e+'" is not valid. valid options are '+Object.keys(_).join(", "))}var s=i(1),a=i(133),o="clpp.player.plugins.broadpeak",c="clpp_broadpeak",u=i(32),l=i(26),h=i(135),d=i(134),_={BEIF15a:"BEIF15a",BEIF15b:"BEIF15b",BEIF15c:"BEIF15c"};s.definePlugin(c,t);var f=s.videojs.getComponent("Player"),p=f.prototype.loadTech_;t.unregisterPlugin=function(){this.cl_sf&&(this.cl_sf.destroy(),this.cl_sf=void 0),f.prototype.loadTech_=p},t.registerPlugin=function(e,t,i){this.cl_sf=new u(o,i),l.makeDeferred(this),this.cl_sf.onPlayerCreated(function(){d(a.LoggerManager.getInstance(),o)}),this.cl_sf.onPlayerLoad(function(e,t){var i=l.getBroadpeakOptions(e);r(i.apiVersion),a.SmartLib.init(new h(t),null,i.analyticsUrl,null,i.broadpeakDomain)}),f.prototype.loadTech_=function(e,t){function i(){n.setTimeout(function(){n.error({code:2,message:"Broadpeak couldn't resolve manifest URL"})},0),n.triggerReady()}var n=this;a.SmartLib.getURL(t.src,function(r){if(!r)return void i();var s=Object.assign({},t,{src:r});p.call(n,e,s)},i)},this.cl_sf.onAutoplayBlocked(function(){}),this.cl_sf.onInit(function(e,t,i){var r=l.getBroadpeakOptions(i);this.cl_cT=r.initCallback||n;var s={};return s.broadpeak=a,this.addDeferred(s,function(){a.PlayerEventListener.onSessionStart(),this.cl_sf.debugDefer("session initialized, session data:",s)}),s}.bind(this)),t.addInterceptor(t.types.TECH_CONSTRUCTOR_READY,function(e){this.cl_cT(a,e.cl_St)}.bind(this)),this.cl_sf.onDestroy(function(e){e&&e.broadpeak&&e.broadpeak.SmartLib&&(e.broadpeak.SmartLib.stopStreamingSession(),e.broadpeak.SmartLib.release(),e.broadpeak=null)}),this.cl_sf.onBitrateChanged(function(e,t,i,n,r){var s;return s=Math.round(r/1e3),e.broadpeak.PlayerEventListener.onLayerSwitch(s),r}),this.cl_sf.onPlaying(function(e){e.broadpeak.PlayerEventListener.onSessionResume()}),this.cl_sf.onPause(function(e){e.broadpeak.PlayerEventListener.onSessionPause()}),this.cl_sf.onSeekingStarted(function(e,t,i,n,r){return e.broadpeak.PlayerEventListener.onSeek(n,r),{seekPosition:n,previousPosition:r}}),this.cl_sf.onBufferingStarted(function(e){return e.broadpeak.PlayerEventListener.onStallStart()}),this.cl_sf.onBufferingEnded(function(e){return e.broadpeak.PlayerEventListener.onStallEnd()}),this.cl_sf.onLoadedMetaData(function(e){this.runDeferred(e)}.bind(this)),this.cl_sf.onSeekingEnded(n),this.cl_sf.onStop(n),this.cl_sf.onError(n),this.cl_sf.onCustomEventRequested(n),this.cl_sf.onAdStarted(n),this.cl_sf.onAdFinished(n),this.cl_sf.start()}},133:function(e,t){function i(){return{isPlaying:function(){return m.getInstance().isPlaying()},isBuffering:function(){return m.getInstance().isBuffering()},isStarted:function(){return m.getInstance().isStarted()},onSessionStart:function(){m.getInstance().onSessionStart()},onSeek:function(e,t){m.getInstance().onSeek(e,t)},onStallStart:function(){m.getInstance().onStallStart()},onStallEnd:function(e){m.getInstance().onStallEnd(e)},onLayerSwitch:function(e){m.getInstance().onLayerSwitch(e)},onSessionPause:function(){m.getInstance().onSessionPause()},onSessionResume:function(){m.getInstance().onSessionResume()}}}function n(){var e=null,t="fservices/metricsReceiver",i="LIVE",n="VOD",r="teardown/",s="?metrics=",a="keepalive",o=1e3;E=1,y=2,A=3;var d=function(){this.isSessionRunning=!1,this.mCurrentSessionID=null,this.mTeardownActivated=!1,this.mStatusCode=0,this.mPlaybackType=null,this.mIsStarted=!1,this.mIsPlaying=!1,this.mIsBuffering=!1,this.mWasSeeking=!1,this.mLastSeekTime=0,this.mRedirectedURL=null,this.mContentURL=null,this.mRedirectionTime=0,this.maxRebufferingDuration=0,this.totalRebufferingDuration=0,this.numberOfRebuffering=0,this.maxStallDuration=0,this.totalStallDuration=0,this.numberOfStalls=0,this.mPlayingStartDate=0,this.mPlayDuration=0,this.mComputedStartupTime=0,this.arrayOfWatchingRange=null,this.arrayOfWatchingRangeIndex=0,this.mBeginWatchingPosition=0,this.mTotalDuration=0,this.mStartSessionDate=0,this.mRedirectionStartDate=0,this.mNanoCdnStatus=E,this.mStartBufferingTime=0,this.mSendKeepAliveAsyncTask=void 0,this.mNanoCDNHostResolvingAsyncTask=void 0,this.mLastLayerBitrate=null,this.arrayOfSwitchBitrate=null,this.mMinBitrate=0,this.mMaxBitrate=0,this.mAvgBitrate=0,this.mCurrentLayer=-1,this.mAnalyticsAddress=void 0,this.metricsPeriodInSeconds=0,this.mPlayerApi=null,this.mNanoCDNHost=null,this.mBroadpeakDomainNames="*",this.mPlayerName="",this.mPlayerVersion="",this.mDeviceType="",this.mUUID=void 0,this.mCustomParameters={},this.mLastSession=void 0,this.initPlayer=function(e){C.getInstance().printMetricsInfoLogs("Init player API..."),this.mPlayerApi=e},this.initMetricManager=function(e,t,i,n,r){C.getInstance().printMetricsInfoLogs("Init metrics manager..."),this.initPlayer(e),this.initPlayerListener(t),this.setAnalyticsPlatformAddress(i);var s=void 0!==n&&null!==n&&0!==n.length;this.mBroadpeakDomainNames=r,this.retrievePlayerName(),this.retrieveDeviceType(),s&&this.mNanoCDNHost!==n?this.resolveNanoCdnHost(n):s||(this.setNanoCDNHost(""),void 0!==this.mNanoCDNHostResolvingAsyncTask&&this.mNanoCDNHostResolvingAsyncTask.stopResolving())},this.getSDKVersion=function(){var e=v;return null!==this.mPlayerApi&&"function"==typeof this.mPlayerApi.getSDKVersion&&(e+="-"+this.mPlayerApi.getSDKVersion()),e},this.getVersion=function(){return this.getSDKVersion()},this.isStarted=function(){return this.mIsStarted},this.isPlaying=function(){return this.mIsPlaying},this.isBuffering=function(){return this.mIsBuffering},this.isTeardownActive=function(){return this.mTeardownActivated},this.setStatusCode=function(e){this.mStatusCode=e},this.release=function(){this.releaseMetricManager(),void 0!==this.mNanoCDNHostResolvingAsyncTask&&this.mNanoCDNHostResolvingAsyncTask.stopResolving()},this.setSessionID=function(e){this.mCurrentSessionID=e},this.setContentURL=function(e){this.mContentURL=e},this.setRedirectUrl=function(e){this.mRedirectedURL=e},this.getPlayerPosition=function(){return null!==this.mPlayerApi&&"function"==typeof this.mPlayerApi.getCurrentPosition?this.mPlayerApi.getCurrentPosition():0},this.getPlayerTotalDuration=function(){return null!==this.mPlayerApi&&"function"==typeof this.mPlayerApi.getTotalDuration?this.mPlayerApi.getTotalDuration():0},this.setPlayerTotalDuration=function(e){this.mTotalDuration=e},this.retrievePlayerVersion=function(){null!==this.mPlayerApi&&"function"==typeof this.mPlayerApi.getVersion?this.mPlayerVersion=this.mPlayerApi.getVersion():this.mPlayerVersion=null},this.setPlayerVersion=function(e){this.mPlayerVersion=e},this.retrieveDeviceType=function(){""===this.mDeviceType&&(null!==this.mPlayerApi&&"function"==typeof this.mPlayerApi.getDeviceType?this.mDeviceType=this.mPlayerApi.getDeviceType():this.mDeviceType="NA")},this.setDeviceType=function(e){this.mDeviceType=e},this.retrievePlayerName=function(){null!==this.mPlayerApi&&"function"==typeof this.mPlayerApi.getPlayerName?this.mPlayerName=this.mPlayerApi.getPlayerName():this.mPlayerName=null},this.setPlayerName=function(e){this.mPlayerName=e},this.getCurrentBitrate=function(){return null!==this.mPlayerApi&&"function"==typeof this.mPlayerApi.getCurrentBitrate?this.mPlayerApi.getCurrentBitrate():0},this.initPeriodicMetrics=function(e){e>0&&(this.metricsPeriodInSeconds=e)},this.setNanoCdnStatusDetected=function(){this.mNanoCdnStatus=y},this.setNanoCdnStatusUsed=function(){this.mNanoCdnStatus=A},this.resolveNanoCdnHost=function(e){return C.getInstance().printMetricsInfoLogs("Initializing nanoCDN resolving with '"+e+"'"),this.setNanoCDNHost(""),"undefined"==typeof e||null===e||0===e.length?void C.getInstance().printMetricsInfoLogs("nanoCDN host resolving is not required for '"+e+"'"):(void 0!==this.mNanoCDNHostResolvingAsyncTask&&this.mNanoCDNHostResolvingAsyncTask.stopResolving(),this.mNanoCDNHostResolvingAsyncTask=new p(e),void this.mNanoCDNHostResolvingAsyncTask.execute())},this.startStreamingSession=function(e){C.getInstance().printMetricsInfoLogs("Starting streaming session..."),void 0!==e&&null!==e||C.getInstance().printMetricsErrorLogs("Exception: You passed a null/undefined contentURL, the session will not work properly."),this.isSessionRunning=!0,this.resetVariables(),this.initSessionPlayerObjects();var t=I.getInstance().getSessionCreated(e);null!==e&&void 0!==e&&(this.mCurrentSessionID=I.getInstance().getTicket(e),this.mTeardownActivated=I.getInstance().isTeardownActivated(e,null,this.mBroadpeakDomainNames,this.mNanoCdnStatus),this.mContentURL=e,this.mRedirectedURL=e),this.mTeardownActivated||t||this.sendCreationMetricsToPlatform(),C.getInstance().printMetricsInfoLogs("Streaming session started")},this.startStreamingSessionRedirect=function(e,t){C.getInstance().printMetricsInfoLogs("Starting streaming session..."),void 0!==e&&null!==e||C.getInstance().printMetricsErrorLogs("Exception: You passed a null/undefined contentURL, the session will not work properly."),void 0!==t&&null!==t||C.getInstance().printMetricsErrorLogs("Exception: You passed a null/undefined redirectURL, the session will not work properly."),this.mRedirectionStartDate>0&&(this.mRedirectionTime=Date.now()-this.mRedirectionStartDate),this.resetVariables(),this.initSessionPlayerObjects(),this.isSessionRunning=!0,void 0!==e&&null!==e&&(this.mContentURL=e),void 0!==t&&null!==t&&(null!==this.mNanoCDNHost&&""!==this.mNanoCDNHost&&void 0!==this.mNanoCDNHost&&(t.indexOf(this.mNanoCDNHost)>=0?this.setNanoCdnStatusUsed():this.setNanoCdnStatusDetected()),this.mCurrentSessionID=I.getInstance().getTicket(t),this.mTeardownActivated=I.getInstance().isTeardownActivated(e,t,this.mBroadpeakDomainNames,this.mNanoCdnStatus),this.mRedirectedURL=t)},this.startStreamingSessionWithRedirect=function(e,t,i){C.getInstance().printMetricsInfoLogs("Starting streaming session with redirect..."),void 0!==e&&null!==e||C.getInstance().printMetricsErrorLogs("Exception: You passed a null/undefined contentURL, the session will not work properly.");var n=this;this.resetVariables(),this.initSessionPlayerObjects(),this.mRedirectionStartDate=Date.now(),b.getInstance().getRedirectedUrl(e,this.getAnalyticsPlatformAddress(),this.mNanoCDNHost,this.mBroadpeakDomainNames,function(i){C.getInstance().printRedirectorInfoLogs("getURL result: "+i),null!==i&&i.length>0&&(n.isSessionRunning=!0);var r=b.getInstance().patchBkmResult(i);n.mCurrentSessionID=I.getInstance().getTicket(r),n.mTeardownActivated=I.getInstance().isTeardownActivated(e,r,n.mBroadpeakDomainNames,n.mNanoCdnStatus),r=b.getInstance().removeBroadpeakParameters(r),n.mRedirectedURL=r,void 0!==e&&null!==e&&(n.mContentURL=e),n.mRedirectionTime=Date.now()-n.mRedirectionStartDate,n.mPlayingStartDate=Date.now();var s=I.getInstance().getSessionCreated(e);n.isTeardownActive()||s||n.sendCreationMetricsToPlatform(),"function"==typeof t&&t(r)},function(e){C.getInstance().printMetricsErrorLogs("Starting streaming session with redirect failed with error message: "+JSON.stringify(e)),"function"==typeof i&&i(e)})},this.stopStreamingSession=function(){C.getInstance().printMetricsInfoLogs("Stopping streaming session..."),this.onStop(),this.releaseSessionPlayerObjects(),this.sendEndSessionMetricsToPlatform()},this.getQuery=function(){var e=m.getInstance().getSDKVersion(),t=null!==this.mNanoCDNHost&&""!==this.mNanoCDNHost&&void 0!==this.mNanoCDNHost,i=t?"nanoCDN host: "+this.mNanoCDNHost:"No nanoCDN host found";C.getInstance().printRedirectorInfoLogs("getQuery: "+i+" (v"+e+")"),this.mRedirectionStartDate=Date.now();var n="bk-ml=1";return t&&(n+="&nanocdnhost="+this.mNanoCDNHost),C.getInstance().printRedirectorInfoLogs("getQuery result : "+n),n},this.sendMetricsToUmbrellaCDN=function(e){},this.initSessionPlayerObjects=function(){return null!==this.mPlayerApi&&"function"==typeof this.mPlayerApi.initSessionPlayerObjects?this.mPlayerApi.initSessionPlayerObjects():0},this.releaseSessionPlayerObjects=function(){return null!==this.mPlayerApi&&"function"==typeof this.mPlayerApi.releaseSessionPlayerObjects?this.mPlayerApi.releaseSessionPlayerObjects():0},this.resetVariables=function(){C.getInstance().resetLogs(),this.mStartSessionDate=Date.now(),this.mPlayingStartDate=Date.now(),this.mCurrentSessionID=null,this.mContentURL=null,this.mRedirectedURL=null,this.mPlaybackType=null,this.mComputedStartupTime=0,this.mLastLayerBitrate=null,this.mBeginWatchingPosition=0,this.mTotalDuration=0,this.mIsPlaying=!1,this.mCurrentLayer=-1,this.maxRebufferingDuration=0,this.totalRebufferingDuration=0,this.numberOfRebuffering=0,this.mWasSeeking=!1,this.maxStallDuration=0,this.totalStallDuration=0,this.numberOfStalls=0,this.mPlayDuration=0,this.mStatusCode=I.getInstance().STATUS_CODE_ENUM.BPSessionEndsNormally.value,this.mIsBuffering=!1,this.mIsStarted=!1,this.arrayOfWatchingRange=[],this.arrayOfWatchingRangeIndex=0,this.arrayOfSwitchBitrate=[],this.mMinBitrate=0,this.mMaxBitrate=0,this.mAvgBitrate=0,this.mTeardownActivated=!1,this.mNanoCdnStatus=E},this.sendCreationMetricsToPlatform=function(){var e=new c(this.mCurrentSessionID,this.mComputedStartupTime,!0);this.postCreationMetrics(e)},this.sendEndSessionMetricsToPlatform=function(){C.getInstance().printMetricsDebugLogs("Stopping metrics manager"),this.isSessionRunning===!0?(this.onSessionEndsWithStatusCode(this.mStatusCode),this.isSessionRunning=!1):C.getInstance().printMetricsErrorLogs("Can't send metrics twice in a session")},this.postCreationMetrics=function(e){var i=this.getAnalyticsPlatformAddress();if(null!==i){var n=i+t;C.getInstance().printMetricsInfoLogs("Posting creation metrics to "+n);var r=new XMLHttpRequest;r.onreadystatechange=function(){4===r.readyState&&(C.getInstance().printMetricsInfoLogs("Send creation session metrics ended with with status code: "+r.status),(r.status<200||r.status>=300)&&C.getInstance().printMetricsDebugLogs("Response text: "+I.getInstance().reduceLog(r.responseText,0,100)),503===r.status&&C.getInstance().printMetricsDebugLogs("Request execution failed"))},r.open("POST",n,!0);var s=I.getInstance().formatCreationMetricObjectIntoJSON(e);C.getInstance().printMetricsVerboseLogs("Executing POST request with body: "+s),r.send(s)}else C.getInstance().printMetricsWarnLogs("Metrics platform URL is null, creation metrics won't be posted anywhere.")},this.getAnalyticsPlatformAddress=function(){return"undefined"==typeof this.mAnalyticsAddress||null===this.mAnalyticsAddress||0===this.mAnalyticsAddress.length?null:this.mAnalyticsAddress},this.setAnalyticsPlatformAddress=function(e){return"undefined"==typeof e||null===e||0===e.length?void(this.mAnalyticsAddress=null):void(I.getInstance().endsWith(e,"/")?this.mAnalyticsAddress=e:this.mAnalyticsAddress=e+"/")},this.setNanoCDNHost=function(e){return"undefined"==typeof e||null===e||0===e.length?void(this.mNanoCDNHost=null):void(this.mNanoCDNHost=e)},this.onSessionEndsWithStatusCode=function(e){C.getInstance().printMetricsDebugLogs("Session ends with status code: "+e),this.stopKeepAlive(),this.mStatusCode=e,this.mIsBuffering&&this.onBufferingEnd(!1);var t=this.retrieveMetrics();null!==t&&(this.mTeardownActivated===!0?this.sendTeardownWithMetrics(t):this.postEndSessionMetrics(t)),this.releaseMetricManager()},this.releaseMetricManager=function(){C.getInstance().printMetricsInfoLogs("Releasing metrics manager...")},this.getOSName=function(){return null!==this.mPlayerApi&&"function"==typeof this.mPlayerApi.getOSName?this.mPlayerApi.getOSName():"undefined"!=typeof device&&device.platform?device.platform:void 0!==window&&void 0!==window.navigator&&void 0!==window.navigator.platform?window.navigator.platform:"NA"},this.getDeviceVersion=function(){if(null!==this.mPlayerApi&&"function"==typeof this.mPlayerApi.getDeviceVersion)return this.mPlayerApi.getDeviceVersion();if("undefined"!=typeof device&&device.version)return device.version;var e=window.navigator.appVersion.replace(/ /g,"_").replace(";","_"),t=e.indexOf(")");return t<=32?e.substring(0,t+1):e.substring(0,32)},this.retrieveAndGetMetrics=function(){return this.updatePreviousBitrateRange(),this.addWatchingRanges(this.mBeginWatchingPosition,this.getPlayerPosition()),this.mIsPlaying&&!this.mIsBuffering&&(this.mPlayDuration+=Date.now()-this.mPlayingStartDate,this.mPlayingStartDate=Date.now()),this.retrieveMetrics()},this.retrieveMetrics=function(){C.getInstance().printMetricsDebugLogs("Retrieving metrics...");var e=this.mRedirectionTime<=0?-1:this.mRedirectionTime,t=this.mComputedStartupTime+this.mRedirectionTime;t=t<=0?-1:t,this.mPlaybackType=this.mTotalDuration<=0?i:n;var r=this.retrievePercentDurationWatched();r>1e3&&(r=1e3);var s=Math.round(this.mPlayDuration<=0?-1:this.mPlayDuration/1e3),a=Math.round((Date.now()-this.mStartSessionDate)/1e3),o=this.arrayOfSwitchBitrate;this.computeBitrates(o);var c=this.retrieveNumberOfSwitch(o),u=I.getInstance().timeSpentPerLayerFromAdaptivePath(this.arrayOfSwitchBitrate),l=this.getOSName(),h=this.getDeviceVersion(),d=new _(this.mCurrentSessionID,this.mStatusCode,e,t,this.mPlaybackType,r,s,a,this.numberOfStalls,this.maxStallDuration,this.totalStallDuration,this.numberOfRebuffering,this.maxRebufferingDuration,this.totalRebufferingDuration,this.mContentURL,this.mRedirectedURL,this.mMaxBitrate,this.mMinBitrate,this.mAvgBitrate,c,u,-1,this.mPlayerName,this.mPlayerVersion,l,h,this.mDeviceType,this.mNanoCdnStatus);return void 0!==this.mUUID&&""!==this.mUUID&&d.setUUID(this.mUUID),d.setCustomParameters(JSON.parse(JSON.stringify(this.mCustomParameters))),C.getInstance().printMetricsDebugLogs(d.toString()),C.getInstance().printMetricsDebugLogs("Metrics are retrieved, ready to be sent"),this.mLastSession=d,d},this.getLastSession=function(){return this.mLastSession},this.retrievePercentDurationWatched=function(){if(this.mPlaybackType===i)return 1e3;var e=JSON.parse(JSON.stringify(this.arrayOfWatchingRange)),t=e.slice(0);if(1===e.length)return Math.floor(1e3*t[0].duration/this.mTotalDuration);if(0===e.length)return 0;var n=[],r=null;t=t.sort(function(e,t){return parseInt(e.start,10)>parseInt(t.start,10)?1:parseInt(e.start,10)<parseInt(t.start,10)?-1:0}),n.push(t[0]);for(var s=1;s<t.length;s++)r=n[n.length-1],parseInt(r.end,10)<parseInt(t[s].start,10)?n.push(t[s]):parseInt(r.end,10)<parseInt(t[s].end,10)&&(r.end=parseInt(t[s].end,10),r.duration=r.end-r.start,n.pop(),n.push(r));var a=0;for(s=0;s<n.length;s++)n[s].duration=parseInt(n[s].end,10)-parseInt(n[s].start,10),a+=parseInt(n[s].duration,10);return this.arrayOfWatchingRange=n,Math.floor(1e3*a/this.mTotalDuration)},this.retrieveNumberOfSwitch=function(e){return 0===e.length?0:e.length-1},this.addWatchingRanges=function(e,t){if(null!==this.arrayOfWatchingRange&&this.mIsStarted&&e<t){var i=new l(e,t);C.getInstance().printMetricsVerboseLogs("Add watching range, duration "+i.duration+"ms"),this.arrayOfWatchingRange.push(i),this.arrayOfWatchingRangeIndex++}},this.buildCurrentBitrateRange=function(e){var t=Math.floor(e),i=new h(Date.now(),-1,t,0);C.getInstance().printMetricsVerboseLogs("Adding bitrate: ("+i.toString()+")"),this.arrayOfSwitchBitrate.push(i),this.mLastLayerBitrate=i,this.mCurrentLayer=e},this.updatePreviousBitrateRange=function(){if(null===this.mLastLayerBitrate)return void C.getInstance().printMetricsVerboseLogs("Last layer is null, cannot update...");var e=new h(this.mLastLayerBitrate.getStartDate(),Date.now(),this.mLastLayerBitrate.getBitrate(),0);C.getInstance().printMetricsVerboseLogs("Updated bitrate: ("+e.toString()+")"),this.arrayOfSwitchBitrate[this.arrayOfSwitchBitrate.length-1]=e},this.retrieveAdaptivePath=function(){if(null===this.arrayOfSwitchBitrate||0===this.arrayOfSwitchBitrate.length)return C.getInstance().printMetricsVerboseLogs("Player stayed on the same layer"),[];for(var e=!0,t=this.arrayOfSwitchBitrate;e;)t=I.getInstance().mergeDuplicateBitrateRange(t),e=I.getInstance().hasDuplicateBitrateRange(t);return t},this.computeBitrates=function(e){this.mAvgBitrate=0,this.mMinBitrate=0,this.mMaxBitrate=0;var t=0,i=0;if(0===e.length)return void C.getInstance().printMetricsVerboseLogs("No switching bitrate");this.mMinBitrate=e[0].getBitrate();for(var n=0;n<e.length;n++)e[n].getBitrate()<this.mMinBitrate&&(this.mMinBitrate=e[n].getBitrate()),e[n].getBitrate()>this.mMaxBitrate&&(this.mMaxBitrate=e[n].getBitrate()),i+=e[n].getBitrate()*e[n].getDuration(),t=Math.floor(t+e[n].getDuration());i/=t,i<0?(C.getInstance().printMetricsDebugLogs("Failed retrieving average bitrate"),i=-1):i>this.mMaxBitrate?(C.getInstance().printMetricsDebugLogs("Average bitrate can't be greater than max bitrate"),i=-1):i<this.mMinBitrate&&(C.getInstance().printMetricsDebugLogs("Average bitrate can't be less than min bitrate"),i=-1),this.mAvgBitrate=Math.floor(i)},this.postEndSessionMetrics=function(e){var i=this.getAnalyticsPlatformAddress();if(null!==i){var n=i+t;C.getInstance().printMetricsInfoLogs("Posting end session metrics to "+n);var r=new XMLHttpRequest;r.onreadystatechange=function(){4===r.readyState&&(C.getInstance().printMetricsInfoLogs("Send end session metrics ended with with status code: "+r.status),(r.status<200||r.status>=300)&&C.getInstance().printMetricsDebugLogs("Response text: "+I.getInstance().reduceLog(r.responseText,0,100)),503===r.status&&C.getInstance().printMetricsDebugLogs("Request execution failed"),m.getInstance().resetCustomParameters())},r.open("POST",n,!0);var s=I.getInstance().formatMetricObjectIntoJSON(e);C.getInstance().printMetricsVerboseLogs("Executing POST request with body: "+s),r.send(s)}else C.getInstance().printMetricsWarnLogs("Metrics platform URL is null, end metrics won't be posted anywhere.")},this.sendTeardownWithMetrics=function(e){var t=this.mRedirectedURL,i=t.indexOf("?");i>0&&(t=t.substring(0,i)),I.getInstance().endsWith(t,"/")||(t+="/"),t+=r,t+=e.getStatusCode(),t+=s+e.getTeardownMetricsString(),C.getInstance().printMetricsInfoLogs("Sending teardown with metrics to "+t);var n=new XMLHttpRequest;n.onreadystatechange=function(){4===n.readyState&&(C.getInstance().printMetricsInfoLogs("Send teardown with metrics end with status code: "+n.status),(n.status<200||n.status>=300)&&C.getInstance().printMetricsDebugLogs("Response text: "+I.getInstance().reduceLog(n.responseText,0,100)))},n.open("GET",t,!0),n.send(null)},this.startKeepAlive=function(){if(this.mTeardownActivated&&(void 0===this.mSendKeepAliveAsyncTask||!this.mSendKeepAliveAsyncTask.isActive())){var e=this.mRedirectedURL,t=e.indexOf("?");t>0&&(e=e.substring(0,t)),I.getInstance().endsWith(e,"/")||(e+="/"),e+=a,this.mSendKeepAliveAsyncTask=new f(this,e),this.mSendKeepAliveAsyncTask.execute()}},this.stopKeepAlive=function(){void 0!==this.mSendKeepAliveAsyncTask&&this.mSendKeepAliveAsyncTask.stopKeepAlive()},this.onStartBuffering=function(){C.getInstance().printMetricsDebugLogs("Player is buffering");var e=Date.now();!this.mIsBuffering&&this.mIsStarted&&(this.mIsBuffering=!0,this.mWasSeeking&&e-this.mLastSeekTime>o&&(this.mWasSeeking=!1),this.mStartBufferingTime=Date.now(),this.mIsPlaying&&(this.mPlayDuration+=e-this.mPlayingStartDate))},this.onBufferingEnd=function(e){Date.now();if(this.mIsStarted&&this.mStartBufferingTime>0){this.mIsBuffering=!1;var t=Date.now()-this.mStartBufferingTime;this.mWasSeeking?(this.mWasSeeking=!1,this.onRebufferingEndWithTime(e,t)):this.onStallingEnd(e,t),e&&(this.mPlayingStartDate=Date.now()),this.mStartBufferingTime=0}},this.onRebufferingEndWithTime=function(e,t){C.getInstance().printMetricsDebugLogs("Player buffered during "+t+"ms"),this.numberOfRebuffering++,this.totalRebufferingDuration+=t,t>this.maxRebufferingDuration&&(this.maxRebufferingDuration=t)},this.onStallingEnd=function(e,t){C.getInstance().printMetricsDebugLogs("Player stalled during "+t+"ms"),this.numberOfStalls++,this.totalStallDuration+=t,t>this.maxStallDuration&&(this.maxStallDuration=t)},this.onJump=function(e,t){C.getInstance().printMetricsDebugLogs("Player jumped from "+e+"ms to "+t+"ms"),this.addWatchingRanges(this.mBeginWatchingPosition,e),this.mBeginWatchingPosition=t,this.mWasSeeking=!0,this.mLastSeekTime=Date.now()},this.onLayerChanged=function(e){if(C.getInstance().printMetricsDebugLogs("Player changed layer to "+e+"kbps"),this.mIsStarted)if(0===this.arrayOfSwitchBitrate.length)C.getInstance().printMetricsDebugLogs("Bitrate updated for the first time, current bandwidth: "+e+"kbps"),this.buildCurrentBitrateRange(e);else{if(e===this.mCurrentLayer)return;C.getInstance().printMetricsDebugLogs("Player changed layer, before: "+this.mLastLayerBitrate.getBitrate()+"kbps, now: "+e+"kbps"),this.updatePreviousBitrateRange(),this.buildCurrentBitrateRange(e)}this.mCurrentLayer=e},this.onStartDownload=function(e){C.getInstance().printMetricsDebugLogs("On start download url: "+e),null===this.mContentURL?this.mContentURL=e:null!==this.mContentURL&&null===this.mRedirectedURL?this.mRedirectedURL=e:null!==this.mContentURL&&null!==this.mRedirectedURL&&null===this.mCurrentSessionID&&this.retrieveTicketFromURL(e)},this.onStartup=function(){this.isSessionRunning||C.getInstance().printMetricsErrorLogs("Implementation error: SmartLib.getURL(...) or SmartLib.startStreamingSession(...) should be called prior to onStartup event. This event is called when the first image is displayed."),C.getInstance().printMetricsInfoLogs("Streaming session started"),this.retrievePlayerVersion(),this.mIsStarted=!0,this.mIsPlaying=!0,this.mTotalDuration=this.getPlayerTotalDuration(),this.mBeginWatchingPosition=this.getPlayerPosition(),this.mComputedStartupTime=Date.now()-this.mPlayingStartDate,this.mPlayingStartDate=Date.now(),this.mCurrentLayer!==-1&&this.onLayerChanged(this.mCurrentLayer),this.startKeepAlive()},this.onPause=function(){this.mIsPlaying&&(C.getInstance().printMetricsDebugLogs("Player is paused"),this.mIsPlaying=!1,this.mIsBuffering||(this.mPlayDuration+=Date.now()-this.mPlayingStartDate),this.addWatchingRanges(this.mBeginWatchingPosition,this.getPlayerPosition()),this.updatePreviousBitrateRange())},this.onResume=function(){this.mIsStarted&&!this.mIsPlaying&&(this.mIsPlaying=!0,this.mIsBuffering=!1,C.getInstance().printMetricsDebugLogs("Player is resumed"),this.mPlayingStartDate=Date.now(),this.mCurrentLayer!==-1&&this.onLayerChanged(this.mCurrentLayer))},this.onStop=function(){C.getInstance().printMetricsDebugLogs("Player is stopped"),this.stopKeepAlive(),this.mIsStarted&&(this.mIsPlaying&&!this.mIsBuffering&&(this.mPlayDuration+=Date.now()-this.mPlayingStartDate),this.mIsBuffering&&this.onBufferingEnd(this.mIsPlaying),this.mIsPlaying&&(this.addWatchingRanges(this.mBeginWatchingPosition,this.getPlayerPosition()),this.mIsPlaying=!1),this.updatePreviousBitrateRange(),this.mIsStarted=!1)},this.retrieveTicketFromURL=function(e){var t=e,i=I.getInstance().getTicket(t);C.getInstance().printMetricsDebugLogs("Ticket: "+i),this.mCurrentSessionID=i},this.retrievePeriodicMetrics=function(){C.getInstance().printMetricsDebugLogs("Retrieving periodic metrics...");var e=this.retrieveAdaptivePath(),t=0;null!==this.mLastLayerBitrate&&(t=this.mLastLayerBitrate.getBitrate());var i=new u(this.mCurrentSessionID,this.numberOfStalls,this.totalStallDuration,this.numberOfRebuffering,this.totalRebufferingDuration,t,null===e||0===e.length?0:e.length-1,this.mPlayDuration<=0?-1:this.mPlayDuration);return C.getInstance().printMetricsDebugLogs(i.toString()),C.getInstance().printMetricsDebugLogs("Periodic metrics are retrieved, ready to be sent"),i},this.initPeriodicMetricsTask=function(){},this.postPeriodicMetrics=function(){C.getInstance().printMetricsDebugLogs("Running post periodic metrics task");var e=this.getAnalyticsPlatformAddress();if(null!==e){var i=e+t,n=this.retrievePeriodicMetrics();if(null===n)return void C.getInstance().printMetricsErrorLogs("Failed to retrieve metrics timeframe");var r=new XMLHttpRequest;r.onreadystatechange=function(){4===r.readyState&&C.getInstance().printMetricsDebugLogs("Send teardown with metrics end with status code : "+r.status+"response text: "+I.getInstance().reduceLog(r.responseText,0,100))},r.open("POST",i,!0),r.setRequestHeader("Content-type","application/json");
var s=I.getInstance().formatPeriodicMetricObjectIntoJSON(n);r.send(s)}else C.getInstance().printMetricsWarnLogs("Metrics platform URL is null, periodic metrics won't be posted anywhere.")},this.onSessionStart=function(){this.onStartup()},this.onSeek=function(e,t){"undefined"!=typeof t?this.onJump(e,t):this.onJump(e,this.getPlayerPosition())},this.onStallStart=function(){this.onStartBuffering()},this.onStallEnd=function(e){this.onBufferingEnd(e)},this.onLayerSwitch=function(e){"undefined"!=typeof e?this.onLayerChanged(e):this.onLayerChanged(this.getCurrentBitrate())},this.onSessionPause=function(){this.onPause()},this.onSessionResume=function(){this.onResume()},this.initPlayerListener=function(e){C.getInstance().printMetricsDebugLogs("Init listeners...")},this.setUUID=function(e){this.mUUID=e},this.setCustomParameter=function(e,t){"string"==typeof e&&"string"==typeof t?this.mCustomParameters[e]=t:C.getInstance().printMetricsWarnLogs("Only string values are accepted for custom parameters")},this.resetCustomParameters=function(){this.mCustomParameters={}}};return{getInstance:function(){return null===e&&(e=new d),e}}}function r(){m=n(),C=o(),I=d(),g=i(),b=a();var e=0,t=!1;return{FORCE_TEARDOWN_DISABLED:-1,FORCE_TEARDOWN_DEFAULT:0,FORCE_TEARDOWN_ENABLED:1,init:function(e,i,n,r,s,a,o){var c=e;t=!0,C.getInstance().printMetricsInfoLogs("Init SmartLib..."),C.getInstance().printMetricsInfoLogs("Version: "+S.getVersion()),"undefined"!=typeof PlayerApiImp&&"function"==typeof PlayerApiImp.setPlayer&&(PlayerApiImp.setPlayer(e),c=PlayerApiImp),"string"!=typeof r&&null!==r||"string"!=typeof s&&null!==s||void 0!==a||void 0!==o?"boolean"!=typeof r||"boolean"!=typeof s||"string"!=typeof a&&null!==a||"string"!=typeof o&&null!==o?(C.getInstance().printMetricsWarnLogs("WARNING: this init method is deprecated, please use SmartLib.init(player, playerListener, analyticsAddress, nanoCDNHost, broadpeakDomainNames)"),C.getInstance().printMetricsInfoLogs('Using SmartLib with default parameters (forceTearDown=SmartLib.FORCE_TEARDOWN_DEFAULT,nanoCdnHost=null,broadpeakDomainNames="*")...'),m.getInstance().initMetricManager(c,i,n,null,"*")):(s===!0&&S.setForceTeardown(1),C.getInstance().printMetricsWarnLogs("WARNING: this init method is deprecated, please use SmartLib.init(player, playerListener, analyticsAddress, nanoCDNHost, broadpeakDomainNames) and SmartLib.setForceTeardown(forceTeardown) before init to keep same behavior"),C.getInstance().printMetricsInfoLogs("Parameters:analyticsAddress="+n+", nanoCDNHost="+a+", broadpeakDomainNames="+o),m.getInstance().initMetricManager(c,i,n,a,o)):(C.getInstance().printMetricsInfoLogs("Parameters:analyticsAddress="+n+", nanoCDNHost="+r+", broadpeakDomainNames="+s),m.getInstance().initMetricManager(c,i,n,r,s))},getURL:function(e,i,n){if(t)m.getInstance().startStreamingSessionWithRedirect(e,i,n);else{var r="Exception: Implementation error, SmartLib.init(...) should be called prior to SmartLib.getURL(...)";C.getInstance().printMetricsErrorLogs(r),n(r)}},getQuery:function(){if(t)return m.getInstance().getQuery();var e="Exception: Implementation error, SmartLib.init(...) should be called prior to SmartLib.getQuery(...)";return C.getInstance().printMetricsErrorLogs(e),""},startStreamingSession:function(e,t){"undefined"!=typeof t?m.getInstance().startStreamingSessionRedirect(e,t):m.getInstance().startStreamingSession(e)},stopStreamingSession:function(e){void 0===e||isNaN(e)||m.getInstance().setStatusCode(e),m.getInstance().stopStreamingSession()},release:function(){C.getInstance().printMetricsInfoLogs("Releasing SmartLib..."),m.getInstance().release(),C.getInstance().resetLogs()},getVersion:function(){return m.getInstance().getVersion()},setUUID:function(e){e.length>32?m.getInstance().setUUID(e.substring(0,32)):m.getInstance().setUUID(e)},setDeviceType:function(e){m.getInstance().setDeviceType(e)},setCustomParameter:function(e,t){m.getInstance().setCustomParameter(e,t)},setForceTeardown:function(t){return"number"!=typeof t?void C.getInstance().printMetricsErrorLogs("Exception: parameter forceTeardown must be SmartLib.FORCE_TEARDOWN_DISABLED, SmartLib.FORCE_TEARDOWN_DEFAULT or SmartLib.FORCE_TEARDOWN_ENABLED"):void(e=t>=1?S.FORCE_TEARDOWN_ENABLED:t<=-1?S.FORCE_TEARDOWN_DISABLED:S.FORCE_TEARDOWN_DEFAULT)},getMetricManager:function(){return m.getInstance()},getForceTeardown:function(){return e}}}function s(){var e=Object.create(S);return e.init=function(e,t,i,n,r,s,a){C.getInstance().printMetricsWarnLogs("WARNING: OTTClient is deprecated, please use SmartLib instead.");var o=e;"undefined"!=typeof PlayerApiImp&&"function"==typeof PlayerApiImp.setPlayer&&(PlayerApiImp.setPlayer(e),o=PlayerApiImp),"undefined"!=typeof s&&"undefined"!=typeof a?(C.getInstance().printMetricsInfoLogs("Using detectNanoCDN and nanoCDNHost..."),m.getInstance().initMetricManager(o,t,i,s===!0?a:null,"*")):"undefined"!=typeof r?m.getInstance().initMetricManager(o,t,i,null,"*"):m.getInstance().initMetricManager(o,t,i,null,"*"),n===!0&&C.getInstance().printMetricsInfoLogs("Multipath allowed but not supported in this version ")},e}function a(){var e=null,t=1e3,i=2e4,n="Location",r=function(){function r(e,t,i){var n=e.indexOf("?"+t+"=");if(n<0&&(n=e.indexOf("&"+t+"=")),n>=0){var r=e.substring(0,e.indexOf(t)),s=e.substring(e.indexOf(t));return s=s.indexOf("&")>=0?s.substring(s.indexOf("&")):"",r+t+"="+i+s}return(e.indexOf("?")<0?e+"?":e+"&")+t+"="+i}function s(e){if(null===e||""===e)return null;var t=e.match("^(https?)\\:\\/\\/(([^:\\/?#]*)(?:\\:([0-9]+))?)([\\/]{0,1}[^?#]*)(\\?[^#]*|)(#.*|)$"),i=t&&{href:e,protocol:t[1],host:t[2],hostname:t[3],port:t[4],path:t[5],query:t[6],hash:t[7]};return null!==i&&null!==i.query&&i.query.length>0&&(i.query=i.query.substring(1)),i}function a(e,t,n){if(t){var s=r(e,"response","200");s=r(s,"bk-ml","1"),C.getInstance().printRedirectorDebugLogs("Sending request to the BkM/umbrella: "+s),o(s,i,function(e){C.getInstance().printRedirectorDebugLogs("BkM/umbrella responded with status code "+e.httpStatus),n(200===e.httpStatus?e.redirectedUrl:"")})}else n(e)}function o(e,t,i){var r=new XMLHttpRequest,s="";r.onreadystatechange=function(){if(4===r.readyState)if(0!==r.status){if(C.getInstance().printRedirectorDebugLogs("Status code: "+r.status+" while retriveving URL: "+e),200===r.status){var t=r.getResponseHeader(n);null!==t&&t.length>0?(s=t,C.getInstance().printRedirectorDebugLogs("Url extracted from location header: "+s)):null!==r.responseText&&r.responseText.length>0?(s=r.responseText,C.getInstance().printRedirectorDebugLogs("Url extracted from response body: "+s)):C.getInstance().printRedirectorWarnLogs("No redirect url found")}i({httpStatus:r.status,redirectedUrl:s})}else C.getInstance().printRedirectorWarnLogs("No response while retrieving request URL:"+e),i({httpStatus:-1,redirectedUrl:""})},r.onerror=function(e){},r.ontimeout=function(){C.getInstance().printRedirectorWarnLogs("Timeout while retrieving request URL:"+e)},C.getInstance().printRedirectorDebugLogs("Starting request asynchronously with url: "+e),r.open("GET",e,!0),r.timeout=t,r.send()}this.getRedirectedUrl=function(n,c,u,l,h,d){if(C.getInstance().printRedirectorInfoLogs("getURL with "+n),void 0===n||null===n||0===n.length)return C.getInstance().printRedirectorWarnLogs("Requested URL is empty"),void h("");var _=s(n),f=void 0!==u&&null!==u&&0!==u.length,p=e.isBroadpeakDomainName(l,n),g=m.getInstance().getSDKVersion();if(f?"*"===l?C.getInstance().printRedirectorInfoLogs("Workflow 5.2 (v"+g+")"):null===l||""===l?C.getInstance().printRedirectorInfoLogs("Workflow 5.4 (v"+g+")"):p?C.getInstance().printRedirectorInfoLogs("Workflow 5.6 => 5.2 (v"+g+")"):C.getInstance().printRedirectorInfoLogs("Workflow 5.6 => 5.4 (v"+g+")"):"*"===l?C.getInstance().printRedirectorInfoLogs("Workflow 5.1 (v"+g+")"):null===l||""===l?C.getInstance().printRedirectorInfoLogs("Workflow 5.3 (v"+g+")"):p?C.getInstance().printRedirectorInfoLogs("Workflow 5.5 => 5.1 (v"+g+")"):C.getInstance().printRedirectorInfoLogs("Workflow 5.5 => 5.3 (v"+g+")"),f){m.getInstance().setNanoCdnStatusDetected();var E="";""!==_.query&&(E="&"+_.query);var y="";null!==c&&(y="&ssu="+this.extractHostnamePort(c));var A="http://"+u+":8000"+_.path+"?response=200&bk-ml=1"+y+"&us="+_.host+E;C.getInstance().printRedirectorDebugLogs("Sending request to the nanoCDN ("+u+")..."),o(A,t,function(e){if(C.getInstance().printRedirectorDebugLogs("nanoCDN responded with status code "+e.httpStatus),200===e.httpStatus||503===e.httpStatus)if(p){var t=r(n,"response","200");t=r(t,"bk-ml","1"),t=r(t,"nanocdnhost",u),C.getInstance().printRedirectorDebugLogs("Sending request to the BkM/umbrella: "+t),o(t,i,function(e){C.getInstance().printRedirectorDebugLogs("BkM/umbrella responded with status code "+e.httpStatus),200===e.httpStatus?(e.redirectedUrl.indexOf(u)>0&&m.getInstance().setNanoCdnStatusUsed(),h(e.redirectedUrl)):h("")})}else 200===e.httpStatus?(m.getInstance().setNanoCdnStatusUsed(),h(e.redirectedUrl)):h(n);else a(n,p,h)})}else a(n,p,h)},this.removeBroadpeakParameters=function(e){var t=s(e);if(null!==t){for(var i="",n=t.query.split("&"),r=0;r<n.length;r++){var a=n[r];I.getInstance().startsWith(a,"bk-")||I.getInstance().startsWith(a,"bpk-")?C.getInstance().printRedirectorDebugLogs("Remove query parameter '"+a+"' from url"):(r>0&&(i+="&"),i+=a)}return""===i?e.replace("?"+t.query,""):e.replace(t.query,i)}return e},this.patchBkmResult=function(e){var t=s(e);if(null!==t){var i=t.query.split("&");if(i.length>=2&&i[0].indexOf("bk-teardown=")===-1)return e.replace("?bk-teardown=","&bk-teardown=")}return e},this.resolveNanoCDNDomainName=function(e,t,i){var n=new XMLHttpRequest;n.onreadystatechange=function(){4===n.readyState&&(200===n.status?t(!0):0!==n.status&&t(!1))},n.onerror=function(){i("Can't resolve nanoCDN:'"+e+"' status:"+n.status)},n.ontimeout=function(){i("Timeout while resolving nanoCDN:'"+e+"' status:"+n.status)},n.open("GET","http://"+e+":"+P+"/nanocdnstatus.xml",!0),n.timeout=500,n.send()},this.extractHostnamePort=function(e){var t;return null===e||""===e?"":(t=e.indexOf("://")>-1?e.split("/")[2]:e.split("/")[0],t=t.split("?")[0])},this.isBroadpeakDomainName=function(e,t){if(null===e||""===e)return!1;if("*"===e)return!0;var i=s(t);if(null!==i&&null!==i.hostname){var n=e.split(",");return n.indexOf(i.hostname)>=0}return!1}};return{getInstance:function(){return null===e&&(e=new r),e}}}function o(){function e(e,t){var i=(new Date).toLocaleTimeString(),n=""+i+": [ "+t+" ] : "+e+"\n";s.length>400&&(s=[]),s.push(n)}function t(e,t){var i=new Date,n=i.getDate()<=9?"0"+i.getDate():i.getDate(),r=i.getMonth()+1<=9?"0"+(i.getMonth()+1):i.getMonth()+1,s=r+"-"+n+" "+i.toLocaleTimeString()+"."+String(i.getMilliseconds()).substr(0,2);switch(t){case c.BPVerbose.value:console.log(s+" V/"+a+": "+e);break;case c.BPDebug.value:console.log(s+" D/"+a+": "+e);break;case c.BPInfo.value:console.log(s+" I/"+a+": "+e);break;case c.BPWarn.value:console.log(s+" W/"+a+": "+e);break;case c.BPError.value:console.log(s+" E/"+a+": "+e)}}function i(e,t){var i=new Date,n=i.getDate()<=9?"0"+i.getDate():i.getDate(),r=i.getMonth()+1<=9?"0"+(i.getMonth()+1):i.getMonth()+1,s=r+"-"+n+" "+i.toLocaleTimeString()+"."+String(i.getMilliseconds()).substr(0,2);switch(t){case c.BPVerbose.value:console.log(s+" V/"+o+": "+e);break;case c.BPDebug.value:console.log(s+" D/"+o+": "+e);break;case c.BPInfo.value:console.log(s+" I/"+o+": "+e);break;case c.BPWarn.value:console.log(s+" W/"+o+": "+e);break;case c.BPError.value:console.log(s+" E/"+o+": "+e)}}var n,r=null,s=[],a="BpkRedirectorCDNManager",o="BpkMetricManager",c={BPError:{value:0,name:"BPError"},BPWarn:{value:1,name:"BPWarn"},BPInfo:{value:2,name:"BPInfo"},BPDebug:{value:3,name:"BPDebug"},BPVerbose:{value:4,name:"BPVerbose"}},u={BPLogLevelVerbose:{value:1,name:"BPLogLevelVerbose"},BPLogLevelBasic:{value:0,name:"BPLogLevelBasic"},BPLogLevelNone:{value:-1,name:"BPLogLevelNone"}},l=function(){this.setLogLevel=function(e){n=e},this.getLogLevel=function(){return n},this.getLogs=function(){return s.join("")},this.saveRedirectorLogs=function(t){e(t,a)},this.saveMetricsLogs=function(t){e(t,o)},this.resetLogs=function(){s=[]},this.printRedirectorDebugLogs=function(e){this.saveRedirectorLogs(e),n<u.BPLogLevelVerbose.value||t(e,c.BPDebug.value)},this.printRedirectorErrorLogs=function(e){this.saveRedirectorLogs(e),n<=u.BPLogLevelNone.value||t(e,c.BPError.value)},this.printRedirectorInfoLogs=function(e){this.saveRedirectorLogs(e),n<=u.BPLogLevelNone.value||t(e,c.BPInfo.value)},this.printRedirectorWarnLogs=function(e){this.saveRedirectorLogs(e),n<=u.BPLogLevelNone.value||t(e,c.BPWarn.value)},this.printRedirectorVerboseLogs=function(e){this.saveRedirectorLogs(e),n<u.BPLogLevelVerbose.value||t(e,c.BPVerbose.value)},this.printMetricsDebugLogs=function(e){this.saveMetricsLogs(e),n<u.BPLogLevelVerbose.value||i(e,c.BPDebug.value)},this.printMetricsErrorLogs=function(e){this.saveMetricsLogs(e),n<=u.BPLogLevelNone.value||i(e,c.BPError.value)},this.printMetricsInfoLogs=function(e){this.saveMetricsLogs(e),n<=u.BPLogLevelNone.value||i(e,c.BPInfo.value)},this.printMetricsWarnLogs=function(e){this.saveMetricsLogs(e),n<=u.BPLogLevelNone.value||i(e,c.BPWarn.value)},this.printMetricsVerboseLogs=function(e){this.saveMetricsLogs(e),n<u.BPLogLevelVerbose.value||i(e,c.BPVerbose.value)}};return{getInstance:function(){return null===r&&(r=new l),r}}}function c(e,t,i){this.session_id=e,this.startup_time=t,this.isStarted=i,this.toString=function(){var e="session metrics: <br/>";return e+=null===this.session_id?"  session id: N/A <br/>":"  session id: "+this.session_id+"<br/>",e+=this.startup_time===-1?"startup time : N/A<br/>":"startup time : "+this.startup_time+"ms<br/>"}}function u(e,t,i,n,r,s,a,o){this.session_id=e,this.number_of_stalls=t,this.stall_duration=i,this.number_of_rebufferings=n,this.rebuffering_duration=r,this.instant_bitrate=s,this.number_of_switches=a,this.duration_played=o,this.toString=function(){var e="session metrics : <br/>";return e+=null===this.session_id?"  session id: N/A <br/>":"  session id: "+this.session_id+"<br/>",e+=this.number_of_stalls===-1?"number of stalls : N/A<br/>":"number of stalls : "+this.number_of_stalls+"ms<br/>",e+=this.stall_duration===-1?"stall duration : N/A<br/>":"stall duration : "+this.stall_duration+"ms<br/>",e+=this.number_of_rebufferings===-1?"number of rebufferings : N/A<br/>":"number of rebufferings : "+this.number_of_rebufferings+"ms<br/>",e+=this.rebuffering_duration===-1?"rebuffering duration : N/A<br/>":"rebuffering duration : "+this.rebuffering_duration+"ms<br/>",e+=this.instant_bitrate===-1?"instant bitrate : N/A<br/>":"instant bitrate : "+this.instant_bitrate+"ms<br/>",e+=this.number_of_switches===-1?"number of switches : N/A<br/>":"number of switches : "+this.number_of_switches+"ms<br/>",e+=this.duration_played===-1?"duration played : N/A<br/>":"duration played : "+this.duration_played+"ms<br/>"}}function l(e,t){this.start=e,this.end=t,this.duration=t-e,this.toString=function(){return"watching range : <br/> start : "+this.start+" <br/> end : "+this.end+" <br/> duration: "+this.duration}}function h(e,t,i,n){this.start=e,this.end=t,this.duration=t-e,this.bitrate=i,this.layerIndex=n,this.marked=!1,this.toString=function(){return"Bitrate_range: start: "+e+", end: "+t+", bitrate: "+i+"kbps, index: "+n},this.getBitrate=function(){return this.bitrate},this.getStartDate=function(){return this.start},this.getEndDate=function(){return this.end},this.setEndDate=function(e){this.end=e},this.getLayerIndex=function(){return this.layerIndex},this.getDuration=function(){return this.duration},this.setDuration=function(e){this.duration=e},this.isMarked=function(){return this.marked},this.mark=function(){this.marked=!0}}function d(){var e=null,t="session_id",i="status_code",n="startup_time",r="redirection_time",s="completion",a="played_time",o="playback_type",c="cnt_stall",u="total_stall_time",d="max_stall_time",_="cnt_rebuffering",f="total_rebuffering_time",p="max_rebuffering_time",g="redirect_url",m="content_url",E="max_bitrate",y="min_bitrate",v="average_bitrate",T="cnt_layer_switch",I="start",P="player_name",R="player_version",L="device_os",N="device_version",D="device_type",w="duration",k="time_spent_per_layer",O="multipath",M="uuid",x="nano_status",B="custom_parameters",U="bk-session_id",F="bk-session",V="^(?:[0-9]{1,3}\\.){3}[0-9]{1,3}(:[0-9]+)?$",Y="^([A-Za-z0-9\\_\\-\\.]+)(:[0-9]+)?$",j="^[0-5a-z]{30,50}$",H="played_time_prd",K="instant_bitrate_prd",G="cnt_layer_switch_prd",W="total_rebuffering_time_prd",q="cnt_rebuffering_prd",Q="total_stall_time_prd",z="cnt_stall_prd",J=function(){function e(e,t){return'"'+e+'":"'+t+'"'}function J(e,t){return'"'+e+'":'+t}function X(e,t){var i;return i=t?'"'+e+'":"true"':'"'+e+'":"false"'}function Z(){return'"'+O+'":{}'}function $(e){for(var t="{",i=0;i<e.adaptive_path.length;i++)t+='"'+e.adaptive_path[i].getBitrate()+'":'+e.adaptive_path[i].getDuration()+",";return null!==e.adaptive_path&&e.adaptive_path.length>0&&(t=t.slice(0,-1)),t+="}",'"'+k+'":'+t}function ee(e,t){return Math.floor(Math.random()*(t-e+1)+e)}function te(e){return e<26?String.fromCharCode(e+"A".charCodeAt(0)):e<52?String.fromCharCode(e-26+"a".charCodeAt(0)):e<62?String.fromCharCode(e-52+"0".charCodeAt(0)):62===e?"+":63===e?"/":void 0}this.STATUS_CODE_ENUM={BPSessionEndsNormally:{value:200,name:"BPSessionEndsNormally"},BPFormatNotSupportedError:{value:3001,name:"BPFormatNotSupportedError"},BPDecodingError:{value:3002,name:"BPDecodingError"},BPNetworkingError:{value:3003,name:"BPNetworkingError"},BPAccessRightError:{value:3004,name:"BPAccessRightError"},BPUnspecifiedError:{value:3005,name:"BPUnspecifiedError"}},this.mergeWatchingRanges=function(e){for(var t=[],i=0;i<e.length;i++){var n=e[i];if(i===e.length-1){t.push(n);break}var r,s=e[i+1];n.start<s.start&&n.end<s.end&&n.end>=s.start?(r=new l(n.start,s.end),t.push(r),e[i+1]=r,e.splice(i,1)):s.start<n.start&&s.end<n.end&&s.end>=n.start?(r=new l(s.start,n.end),t.push(r),e[i+1]=r,e.splice(i,1)):n.start<=s.start&&n.end>s.end&&n.duration>s.duration?(r=new l(n.start,n.end),t.push(r),e[i+1]=r,e.splice(i,1)):s.start<=n.start&&s.end>n.end&&s.duration>n.duration?(r=new l(s.start,s.end),e[i+1]=r,e.splice(i,1)):n.start<s.start&&n.end<s.start?t.push(n):s.start<n.start&&s.end<n.start&&t.push(n)}return t},this.hasDuplicateBitrateRange=function(e){var t=!1;e:for(var i=0;i<e.length;i++)for(var n=i+1;n<e.length;n++)if(e[i].getBitrate()===e[n].getBitrate()){t=!0;break e}return t},this.sortLayersList=function(e){for(var t=[],i=0;i<e.length;i++){var n=e[i];if(i===e.length-1)t.push(n);else{var r=e[i+1];if(n.getBitrate()!==r.getBitrate())r.getStartDate()!==-1&&r.getEndDate()!==-1||t.splice(i+1,1),t.push(n);else if(n.getStart()===-1||n.getEnd()===-1)t.splice(i,1);else{var s=new h(n.getStart(),r.getEnd(),n.getBitrate(),n.getDuration()+r.getDuration());t.push(s),i++}}}return t},this.mergeDuplicateBitrateRange=function(e){var t=this.copyRawLayersList(e),i=[];if(0===t.length)return i;for(var n=0;n<t.length;n++){var r=t[n];if(!r.isMarked()){for(var s=n+1;s<t.length;s++){var a=t[s];r.getBitrate()===a.getBitrate()&&(r.setDuration(r.getDuration()+a.getDuration()),r.setEndDate(a.getEndDate()),a.mark())}i.push(r)}}return i},this.copyRawLayersList=function(e){for(var t=[],i=0;i<e.length;i++){var n=e[i];t.push(new h(n.getStartDate(),n.getEndDate(),n.getBitrate(),n.getLayerIndex()))}return t},this.getStatusCodeStringValue=function(e){var t=0;return t=e===this.STATUS_CODE_ENUM.BPSessionEndsNormally.value?this.STATUS_CODE_ENUM.BPSessionEndsNormally.name:e===this.STATUS_CODE_ENUM.BPFormatNotSupportedError.value?this.STATUS_CODE_ENUM.BPFormatNotSupportedError.name:e===this.STATUS_CODE_ENUM.BPDecodingError.value?this.STATUS_CODE_ENUM.BPDecodingError.name:e===this.STATUS_CODE_ENUM.BPNetworkingError.value?this.STATUS_CODE_ENUM.BPNetworkingError.name:e===this.STATUS_CODE_ENUM.BPAccessRightError.value?this.STATUS_CODE_ENUM.BPAccessRightError.name:this.STATUS_CODE_ENUM.BPUnspecifiedError.name},this.isSafari=function(){var e=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0;return e},this.timeSpentPerLayerFromAdaptivePath=function(e){for(var t=[],i=0;i<e.length;i++){for(var n=!1,r=0;r<t.length&&!n;r++)e[i].getBitrate()===t[r].getBitrate()&&(n=!0,t[r].setEndDate(e[i].getEndDate()),t[r].setDuration(t[r].getDuration()+e[i].getDuration()));if(!n){var s=new h(e[i].getStartDate(),e[i].getEndDate(),e[i].getBitrate(),0);t.push(s)}}return t},this.isArraysEquals=function(e,t){var i=e.length===t.length&&e.every(function(e,i){return e===t[i]});return i},this.convertBitrateInKBPS=function(e){var t=e/1024;return t=parseInt(t,10)},this.formatMetricObjectIntoJSON=function(l){var h=new Array;return h[h.length]="{",h[h.length]=e(t,l.session_id),h[h.length]=",",h[h.length]=J(r,l.redirection_time),h[h.length]=",",h[h.length]=J(i,l.status_code),h[h.length]=",",h[h.length]=J(n,l.startup_time),h[h.length]=",",h[h.length]=J(s,l.completion),h[h.length]=",",h[h.length]=J(a,l.duration_played),h[h.length]=",",h[h.length]=e(o,l.playback_type),h[h.length]=",",h[h.length]=J(c,l.number_of_stalls),h[h.length]=",",h[h.length]=J(d,l.max_stall_duration),h[h.length]=",",h[h.length]=J(u,l.total_stall_duration),h[h.length]=",",h[h.length]=J(_,l.number_of_rebuffering),h[h.length]=",",h[h.length]=J(p,l.max_rebuffering_time),h[h.length]=",",h[h.length]=J(f,l.total_rebuffering_time),h[h.length]=",",h[h.length]=e(m,l.content_url),h[h.length]=",",h[h.length]=e(g,l.redirected_url),h[h.length]=",",h[h.length]=J(E,l.max_bitrate),h[h.length]=",",h[h.length]=J(y,l.min_bitrate),h[h.length]=",",h[h.length]=J(v,l.average_bitrate),h[h.length]=",",h[h.length]=J(T,l.number_of_switch),h[h.length]=",",h[h.length]=e(P,l.player_name),h[h.length]=",",h[h.length]=e(R,l.player_version),h[h.length]=",",h[h.length]=e(D,l.device_type),h[h.length]=",",h[h.length]=e(N,l.device_version),h[h.length]=",",h[h.length]=e(L,l.os_name),h[h.length]=",",h[h.length]=J(w,l.total_duration),h[h.length]=",",h[h.length]=X(I,!1),h[h.length]=",",h[h.length]=Z(),h[h.length]=",",h[h.length]=$(l),h[h.length]=",",h[h.length]=e(M,l.getUUID()),h[h.length]=",",h[h.length]=J(x,l.getNanoCdnStatus()),Object.keys(l.getCustomParameters()).length>0&&(h[h.length]=",",h[h.length]=J(B,JSON.stringify(l.getCustomParameters()))),h[h.length]="}",h.join("")},this.generateTicket=function(){var e="",t=Date.now(),i=ee(1e6,9999999),n=this.btoa(i+t);return null===n?(C.getInstance().printMetricsWarnLogs("Cannot encode base 64 ticket"),""):(e=n,C.getInstance().printMetricsVerboseLogs("Ticket generated: "+e),e)},this.formatCreationMetricObjectIntoJSON=function(e){var i="{";return i=i+'"'+t+'":"'+e.session_id+'",',i=i+'"'+n+'":'+e.startup_time+",",i=i+'"'+I+'":'+e.isStarted,i+="}"},this.formatPeriodicMetricObjectIntoJSON=function(e){var i="{";return i=i+'"'+t+'":"'+e.session_id+'",',i=i+'"'+H+'":'+e.duration_played+",",i=i+'"'+z+'":'+e.number_of_stalls+",",i=i+'"'+Q+'":'+e.stall_duration+",",i=i+'"'+q+'":'+e.number_of_rebufferings+",",i=i+'"'+W+'":'+e.rebuffering_duration+",",i=i+'"'+K+'":'+e.instant_bitrate+",",i=i+'"'+G+'":'+e.number_of_switches+",",i=i+'"'+I+'":"Periodic"',i+="}"},this.startsWith=function(e,t){return 0===e.indexOf(t)},this.endsWith=function(e,t){return null!==e&&void 0!==e&&e.indexOf(t,e.length-t.length)!==-1},this.reduceLog=function(e,t,i){try{return e.substring(t,i).replace(new RegExp("\n","g")," ")}catch(t){return e}},this.getTeardown=function(e){var t=this.getParameterByName("bk-teardown",e);return this.startsWith(t,"T")||this.startsWith(t,"t")||this.startsWith(t,"1")},this.isTeardownActivated=function(e,t,i,n){return S.getForceTeardown()===S.FORCE_TEARDOWN_ENABLED?(C.getInstance().printMetricsInfoLogs("Session will start with keepalives/teardown (forceTeardown)"),!0):S.getForceTeardown()===S.FORCE_TEARDOWN_DISABLED?(C.getInstance().printMetricsInfoLogs("Session will start without keepalives/teardown (forceTeardown)"),!1):null!==t&&"0"===this.getParameterByName("bk-teardown",t)?(C.getInstance().printMetricsInfoLogs("Session will start without keepalives/teardown (bk-teardown=0)"),!1):null!==t&&this.getTeardown(t)?(C.getInstance().printMetricsInfoLogs("Session will start with keepalives/teardown (bk-teardown=1)"),!0):null!==e&&b.getInstance().isBroadpeakDomainName(i,e)?(C.getInstance().printMetricsInfoLogs("Session will start with keepalives/teardown (in broadpeak domains list)"),!0):n===A?(C.getInstance().printMetricsInfoLogs("Session will start with keepalives/teardown (nanoCDN used)"),!0):(C.getInstance().printMetricsInfoLogs("Session will start without keepalives/teardown"),!1)},this.getSessionCreated=function(e){var t=this.getParameterByName(U,e);return""!==t||(t=this.getParameterByName(F,e),this.startsWith(t,"T")||this.startsWith(t,"t")||this.startsWith(t,"1"))},this.getTicket=function(e){var t,i="";if(i=this.getParameterByName(U,e),""===i&&(t=e.split("/"),t.length>=4&&t[3].match("\\[(.*)\\]")&&(i=t[3].substring(1,t[3].length-1))),""===i){var n=e.split("//"),r=n[n.length-1];t=r.split("/"),t.length>=2&&(t[0].match(V)||t[0].match(Y))&&t[1].match(j)&&(i=t[1],C.getInstance().printMetricsVerboseLogs("Ticket detected: "+i))}return""===i&&(i=this.generateTicket()),""===i&&(C.getInstance().printMetricsWarnLogs("Failed getting ticket"),C.getInstance().printMetricsWarnLogs("Metrics library won't be able to post metrics")),i},this.getParameterByName=function(e,t){if(!t)return"";e=e.replace(/[\[\]]/g,"\\$&");var i=new RegExp("[?&]"+e+"(=([^&#]*)|&|#|$)"),n=i.exec(t);return n&&n[2]?decodeURIComponent(n[2].replace(/\+/g," ")):""},this.btoa=function(e){var t;for(e=String(e),t=0;t<e.length;t++)if(e.charCodeAt(t)>255)return null;var i="";for(t=0;t<e.length;t+=3){var n=[void 0,void 0,void 0,void 0];n[0]=e.charCodeAt(t)>>2,n[1]=(3&e.charCodeAt(t))<<4,e.length>t+1&&(n[1]|=e.charCodeAt(t+1)>>4,n[2]=(15&e.charCodeAt(t+1))<<2),e.length>t+2&&(n[2]|=e.charCodeAt(t+2)>>6,n[3]=63&e.charCodeAt(t+2));for(var r=0;r<n.length;r++)i+="undefined"==typeof n[r]?"=":te(n[r])}return i}};return{getInstance:function(){return null===e&&(e=new J),e}}}function _(e,t,i,n,r,s,a,o,c,u,l,h,d,_,f,p,g,m,E,y,A,v,S,T,b,C,P,R){function L(e){for(var t="",i=0;i<e.length;i++){var n=e[i];""!==t&&(t+=","),t+=n.getBitrate()+":"+n.getDuration()}return t}this.session_id=e,this.redirection_time=i,this.status_code=t,this.startup_time=n,this.completion=s,this.duration_played=a,this.playback_type=r,this.number_of_stalls=c,this.max_stall_duration=u,this.total_stall_duration=l,this.number_of_rebuffering=h,this.max_rebuffering_time=d,this.total_rebuffering_time=_,this.content_url=f,this.redirected_url=p,this.max_bitrate=g,this.min_bitrate=m,this.average_bitrate=E,this.number_of_switch=y,this.adaptive_path=A,this.player_name=S,this.player_version=T,this.device_version=C,this.device_type=P,this.os_name=b,this.total_duration=o,this.frames_dropped_number=v,this.nanocdn_status=R,this.mUUID="",this.mCustomParameters={},this.toString=function(){var e=new Array;if(e[e.length]="Session metrics:",e[e.length]="\nsession id: "+this.session_id,e[e.length]="\nplayer name: "+this.player_name,e[e.length]="\nplayer version: "+this.player_version,e[e.length]="\ndevice type: "+this.device_type,e[e.length]="\ndevice version: "+this.device_version,e[e.length]="\nos name: "+this.os_name,e[e.length]="\nuuid: "+this.mUUID,this.redirection_time===-1?e[e.length]="\nredirection time: N/A":e[e.length]="\nredirection time: "+this.redirection_time+"ms",e[e.length]="\nstatus code: "+I.getInstance().getStatusCodeStringValue(this.status_code),this.startup_time===-1?e[e.length]="\nstartup time: N/A":e[e.length]="\nstartup time: "+this.startup_time+"ms",e[e.length]="\ncompletion: "+this.completion/10+"%",e[e.length]="\nduration played: "+this.duration_played+" secs",e[e.length]="\ntotal duration: "+this.total_duration+" secs",e[e.length]="\nplayback type: "+this.playback_type,e[e.length]="\nnumber of stalls: "+this.number_of_stalls,this.max_stall_duration===-1?e[e.length]="\nmax stall duration: N/A":e[e.length]="\nmax stall duration: "+this.max_stall_duration+"ms",this.total_stall_duration===-1?e[e.length]="\ntotal stall duration: N/A":e[e.length]="\ntotal stall duration: "+this.total_stall_duration+"ms",e[e.length]="\nnumber of rebuffering: "+this.number_of_rebuffering,e[e.length]="\nmax rebuffering time: "+this.max_rebuffering_time+"ms",e[e.length]="\ntotal rebuffering time: "+this.total_rebuffering_time+"ms",e[e.length]="\ncontent url: "+this.content_url,e[e.length]="\nredirected url: "+this.redirected_url,this.max_bitrate===-1?e[e.length]="\nmax bitrate: N/A":e[e.length]="\nmax bitrate: "+this.max_bitrate+" kbps",this.min_bitrate===-1?e[e.length]="\nmin bitrate: N/A":e[e.length]="\nmin bitrate: "+this.min_bitrate+" kbps",this.average_bitrate===-1?e[e.length]="\naverage bitrate: N/A":e[e.length]="\naverage bitrate: "+this.average_bitrate+" kbps",0===this.number_of_switch?e[e.length]="\nnumber of switch: N/A":e[e.length]="\nnumber of switch: "+this.number_of_switch,null===this.number_of_switch)e[e.length]="\ntime per layer: N/A";else if(e[e.length]="\ntime per layer: ",0===this.adaptive_path.length)e[e.length]=" N/A";else for(var t=0;t<this.adaptive_path.length;t++)e[e.length]="\n layer "+t+": "+this.adaptive_path[t].getBitrate()+"kbps,"+this.adaptive_path[t].getDuration()+"ms";return e[e.length]="\nnanocdn status: "+R,void 0!==this.mCustomParameters&&(e[e.length]="\ncustom parameters: "+JSON.stringify(this.mCustomParameters)),e.join("")},this.getStatusCode=function(){return this.status_code},this.getUUID=function(){return this.mUUID},this.setUUID=function(e){this.mUUID=e},this.getNanoCdnStatus=function(){return this.nanocdn_status},this.getCustomParameters=function(){return this.mCustomParameters},this.setCustomParameters=function(e){this.mCustomParameters=e},this.getTeardownMetricsString=function(){var e=this.redirection_time+"+"+encodeURIComponent(this.player_name)+"+"+encodeURIComponent(this.player_version)+"+"+encodeURIComponent(this.os_name)+"+"+encodeURIComponent(this.device_version)+"+"+encodeURIComponent(this.device_type)+"+"+this.startup_time+"+"+this.completion+"+"+this.duration_played+"+"+this.playback_type+"+"+this.number_of_stalls+"+"+this.max_stall_duration+"+"+this.total_stall_duration+"+"+this.number_of_rebuffering+"+"+this.max_rebuffering_time+"+"+this.total_rebuffering_time+"+"+this.max_bitrate+"+"+this.min_bitrate+"+"+this.average_bitrate+"+"+this.number_of_switch+"+"+this.total_duration+"+"+L(this.adaptive_path)+"+"+encodeURIComponent(this.mUUID)+"+"+this.nanocdn_status;return e}}function f(e,t){var i="?metrics=",n=5e3,r=this;this.mMetricManager=e,this.mMetricsPlatformURL=t,this.mActive=!0,this.mInterval=void 0,this.execute=function(){this.mInterval=setInterval(function(){if(r.mActive){var e=r.mMetricManager.retrieveAndGetMetrics(),t=r.mMetricsPlatformURL+i+e.getTeardownMetricsString();C.getInstance().printMetricsInfoLogs("Sending keepalive with metrics to "+t);var n=new XMLHttpRequest;n.onreadystatechange=function(){4===n.readyState&&(C.getInstance().printMetricsInfoLogs("Send keepalive with metrics end with status code: "+n.status),(n.status<200||n.status>=300)&&(C.getInstance().printMetricsDebugLogs("Response text: "+I.getInstance().reduceLog(n.responseText,0,100)),C.getInstance().printMetricsDebugLogs("Stopping keepalive..."),r.stopKeepAlive()))},n.open("GET",t,!0),n.send(null)}},n)},this.stopKeepAlive=function(){this.mActive=!1,clearInterval(this.mInterval)},this.isActive=function(){return this.mActive}}function p(e){var t=1e4,i=this;this.mNanoCDNHost=e,this.mRetry=0,this.mActive=!0,this.mTimeout=void 0,this.execute=function(){C.getInstance().printMetricsDebugLogs("Starting resolving nanoCDN with host: '"+i.mNanoCDNHost+"'"),b.getInstance().resolveNanoCDNDomainName(i.mNanoCDNHost,function(e){i.mActive&&(C.getInstance().printMetricsInfoLogs("Found nanoCDN with host: '"+i.mNanoCDNHost+"'"),m.getInstance().setNanoCDNHost(i.mNanoCDNHost),i.mActive=!1)},function(e){i.mActive&&(i.mRetry++,C.getInstance().printMetricsDebugLogs(e+" retry:"+i.mRetry),
i.mRetry<4?(clearTimeout(i.mTimeout),i.mTimeout=setTimeout(function(){i.mActive&&i.execute()},t*i.mRetry)):(C.getInstance().printMetricsInfoLogs("Can't found nanoCDN with host: '"+i.mNanoCDNHost+"'"),i.mActive=!1))})},this.stopResolving=function(){this.mActive||C.getInstance().printMetricsDebugLogs("Host resolving stopped for '"+i.mNanoCDNHost+"'"),this.mActive=!1,clearTimeout(this.mTimeout)},this.isActive=function(){return this.mActive}}var g,m,E,y,A,v="02.04.01";S=r(),T=s();var S,T,b,C,I,P="18081",R={OTTClient:T,SmartLib:S,LoggerManager:C,PlayerEventListener:g};"undefined"!=typeof e&&e.exports?e.exports=R:window.broadpeak=R},134:function(e,t,i){function n(e,t){function i(e){var t={};e=e||"";for(var i,n,r,s=e.split("\n"),a=1,o=s.length;a<o;a++)i=s[a].split(":"),n=i[0].replace(/^\s{0,}|\s{0,}$/g,""),i.splice(0,1),r=i.join(":"),n&&(t[n]=r);return t}var n=new r.Logger(t+".sdk"),s=new r.Logger(t+".sdk.redirector"),a=e.saveMetricsLogs,o=e.saveRedirectorLogs;e.printMetricsInfoLogs=function(){a.apply(this,arguments),n.info.apply(n,arguments)},e.printMetricsErrorLogs=function(){a.apply(this,arguments),n.error.apply(n,arguments)},e.printMetricsWarnLogs=function(){a.apply(this,arguments),n.warn.apply(n,arguments)},e.printMetricsDebugLogs=function(){var e=Array.prototype.slice.call(arguments),t=e[0];a.apply(this,arguments),t&&0===t.indexOf("session metrics:")&&(e.push(i(t)),e[0]="session metrics"),n.debug.apply(n,e)},e.printMetricsVerboseLogs=function(){a.apply(this,arguments),n.debug.apply(n,arguments)},e.printRedirectorInfoLogs=function(){o.apply(this,arguments),s.info.apply(s,arguments)},e.printRedirectorErrorLogs=function(){o.apply(this,arguments),s.error.apply(s,arguments)},e.printRedirectorWarnLogs=function(){o.apply(this,arguments),s.warn.apply(s,arguments)},e.printRedirectorDebugLogs=function(){o.apply(this,arguments),s.debug.apply(s,arguments)},e.printRedirectorVerboseLogs=function(){o.apply(this,arguments),s.debug.apply(s,arguments)}}var r=i(4);e.exports=n},135:function(e,t,i){function n(e){this.cl_Mt=e,this.handle=""}var r=n.prototype;r.getVersion=function(){return"5.1.36"},r.getTotalDuration=function(){return this.cl_Mt.duration()},r.getCurrentPosition=function(){return this.cl_Mt.currentTime()},r.getCurrentBitrate=function(){return this.cl_Mt.getStats().streamBandwidth},r.getStatuscode=function(){return 200},r.getPlayerName=function(){return"@castlabs/prestoplay"},r.getDeviceType=function(){return"PC"},r.setSessionHandle=function(e){this.handle=e},r.getInstance=function(){return this},e.exports=n}})})}])});